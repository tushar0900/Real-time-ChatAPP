const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./module-_-3Zp_Bt.js","./react-vendor-Dw_yU8dF.js","./axios-vendor-DGEJccjb.js"])))=>i.map(i=>d[i]);
import{r as e,g as t,a as r}from"./react-vendor-Dw_yU8dF.js";import{a as n}from"./axios-vendor-DGEJccjb.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const r of e)if("childList"===r.type)for(const e of r.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var s,i,o={exports:{}},a={};var c=(i||(i=1,o.exports=function(){if(s)return a;s=1;var t=e(),r=Symbol.for("react.element"),n=Symbol.for("react.fragment"),i=Object.prototype.hasOwnProperty,o=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function l(e,t,n){var s,a={},l=null,d=null;for(s in void 0!==n&&(l=""+n),void 0!==t.key&&(l=""+t.key),void 0!==t.ref&&(d=t.ref),t)i.call(t,s)&&!c.hasOwnProperty(s)&&(a[s]=t[s]);if(e&&e.defaultProps)for(s in t=e.defaultProps)void 0===a[s]&&(a[s]=t[s]);return{$$typeof:r,type:e,key:l,ref:d,props:a,_owner:o.current}}return a.Fragment=n,a.jsx=l,a.jsxs=l,a}()),o.exports),l=e();const d=t(l);var u,h={};const p=t(function(){if(u)return h;u=1;var e=r();return h.createRoot=e.createRoot,h.hydrateRoot=e.hydrateRoot,h}()),m={},f=function(e,t,r){let n=Promise.resolve();if(t&&t.length>0){let e=function(e){return Promise.all(e.map(e=>Promise.resolve(e).then(e=>({status:"fulfilled",value:e}),e=>({status:"rejected",reason:e}))))};const s=document.getElementsByTagName("link"),i=document.querySelector("meta[property=csp-nonce]"),o=i?.nonce||i?.getAttribute("nonce");n=e(t.map(e=>{if(e=function(e,t){return new URL(e,t).href}(e,r),e in m)return;m[e]=!0;const t=e.endsWith(".css"),n=t?'[rel="stylesheet"]':"";if(r)for(let r=s.length-1;r>=0;r--){const n=s[r];if(n.href===e&&(!t||"stylesheet"===n.rel))return}else if(document.querySelector(`link[href="${e}"]${n}`))return;const i=document.createElement("link");return i.rel=t?"stylesheet":"modulepreload",t||(i.as="script"),i.crossOrigin="",i.href=e,o&&i.setAttribute("nonce",o),document.head.appendChild(i),t?new Promise((t,r)=>{i.addEventListener("load",t),i.addEventListener("error",()=>r(new Error(`Unable to preload CSS for ${e}`)))}):void 0}))}function s(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return n.then(t=>{for(const e of t||[])"rejected"===e.status&&s(e.reason);return e().catch(s)})};const g="chatapp-auth-session",y="userId",v="username",b="token";function w(e){return null==e?"":String(e).trim()}function x(e){if(!e||"object"!=typeof e)return null;const t=w(e.userId),r=w(e.token),n=w(e.username);return t&&r?{userId:t,username:n,token:r}:null}function S(e){try{const t=e.getItem(g);return t?x(JSON.parse(t)):null}catch{return null}}function j(e){try{const t=w(e.getItem(y)),r=w(e.getItem(b)),n=w(e.getItem(v));return t&&r?{userId:t,username:n,token:r}:null}catch{return null}}function C(e,t){e.setItem(g,JSON.stringify(t)),e.setItem(y,t.userId),e.setItem(v,t.username||""),e.setItem(b,t.token)}function _(e){e.removeItem(g),e.removeItem(y),e.removeItem(v),e.removeItem(b)}function k(){if("undefined"==typeof window)return{userId:"",username:"",token:""};const e=S(window.sessionStorage)||j(window.sessionStorage);if(e)return e;const t=S(window.localStorage)||j(window.localStorage);if(!t)return{userId:"",username:"",token:""};try{C(window.sessionStorage,t)}catch{}return t}function N(e){if("undefined"==typeof window)return!1;const t=x(e);if(!t)return!1;try{return C(window.sessionStorage,t),C(window.localStorage,t),!0}catch{return!1}}function E({onLoginSuccess:e,onSwitchToSignup:t}){const r=`${"https://real-time-chatapp-o0me.onrender.com".replace(/\/$/,"")}/api/users/login`,[s,i]=l.useState({email:"",password:""}),[o,a]=l.useState(""),[d,u]=l.useState(!1),[h,p]=l.useState(!1);function m(e){const{name:t,value:r}=e.target;i(e=>({...e,[t]:r}))}return c.jsx("div",{className:"auth-form",children:c.jsxs("form",{onSubmit:async function(t){if(t.preventDefault(),a(""),u(!0),!s.email.includes("@"))return a("Invalid email"),void u(!1);if(s.password.length<6)return a("Password must be at least 6 characters"),void u(!1);try{const t=await n.post(r,{email:s.email.trim(),password:s.password},{timeout:8e3});N({userId:t.data?.user?._id,username:t.data?.user?.username||"",token:t.data?.token}),e&&e()}catch(i){const e=i.response?.data?.message,t=i.response?.status;e?a(`${e} (status ${t||"unknown"})`):"ECONNABORTED"===i.code?a("Request timed out. Check whether the backend is running."):"Network Error"===i.message?a("Network error. Check backend URL, CORS, and server status."):i.message?a(`${i.message} (status ${t||"network"})`):a("Login failed. Check the backend and network.")}finally{u(!1)}},children:[c.jsxs("div",{className:"form-group",children:[c.jsx("label",{htmlFor:"email",children:"Email Address"}),c.jsx("input",{id:"email",type:"email",name:"email",placeholder:"your@email.com",value:s.email,onChange:m,autoComplete:"email",required:!0})]}),c.jsxs("div",{className:"form-group",children:[c.jsx("label",{htmlFor:"password",children:"Password"}),c.jsxs("div",{className:"password-field",children:[c.jsx("input",{id:"password",type:h?"text":"password",name:"password",placeholder:"********",value:s.password,onChange:m,autoComplete:"current-password",required:!0}),c.jsx("button",{type:"button",className:"password-toggle",onClick:()=>p(e=>!e),"aria-label":h?"Hide password":"Show password",title:h?"Hide password":"Show password",children:h?"Hide":"Show"})]})]}),o&&c.jsx("div",{className:"error-message",children:o}),c.jsxs("button",{type:"submit",disabled:d,className:"submit-btn",children:[d?c.jsx("span",{className:"spinner"}):null,d?"Logging in...":"Login"]}),c.jsxs("p",{className:"auth-switch",children:["Don't have an account? ",c.jsx("button",{type:"button",className:"auth-switch-btn",onClick:t,children:"Sign up"})]})]})})}function R({onSignupSuccess:e,onSwitchToLogin:t}){const r=`${"https://real-time-chatapp-o0me.onrender.com".replace(/\/$/,"")}/api/users/sign-up`,[s,i]=l.useState({username:"",email:"",password:"",confirm:""}),[o,a]=l.useState(""),[d,u]=l.useState(!1),[h,p]=l.useState(!1),[m,f]=l.useState(!1);function g(e){const{name:t,value:r}=e.target;i(e=>({...e,[t]:r}))}return c.jsx("div",{className:"auth-form",children:c.jsxs("form",{onSubmit:async function(t){if(t.preventDefault(),a(""),u(!0),s.username.trim().length<3)return a("Username must be at least 3 characters"),void u(!1);if(!s.email.includes("@"))return a("Invalid email"),void u(!1);if(s.password.length<6)return a("Password must be at least 6 characters"),void u(!1);if(s.password!==s.confirm)return a("Passwords do not match"),void u(!1);try{await n.post(r,{username:s.username.trim(),name:s.username.trim(),email:s.email.trim(),password:s.password},{timeout:8e3}),e&&e()}catch(i){const e=i.response?.data?.message,t=i.response?.status;e?a(`${e} (status ${t||"unknown"})`):"ECONNABORTED"===i.code?a("Request timed out. Check whether the backend is running."):"Network Error"===i.message?a("Network error. Check backend URL, CORS, and server status."):i.message?a(`${i.message} (status ${t||"network"})`):a("Sign-up failed. Check the backend and network.")}finally{u(!1)}},children:[c.jsxs("div",{className:"form-group",children:[c.jsx("label",{htmlFor:"username",children:"Username"}),c.jsx("input",{id:"username",type:"text",name:"username",placeholder:"Choose a username",value:s.username,onChange:g,autoComplete:"username",required:!0})]}),c.jsxs("div",{className:"form-group",children:[c.jsx("label",{htmlFor:"email",children:"Email Address"}),c.jsx("input",{id:"email",type:"email",name:"email",placeholder:"your@email.com",value:s.email,onChange:g,autoComplete:"email",required:!0})]}),c.jsxs("div",{className:"form-group",children:[c.jsx("label",{htmlFor:"password",children:"Password"}),c.jsxs("div",{className:"password-field",children:[c.jsx("input",{id:"password",type:h?"text":"password",name:"password",placeholder:"********",value:s.password,onChange:g,autoComplete:"new-password",required:!0}),c.jsx("button",{type:"button",className:"password-toggle",onClick:()=>p(e=>!e),"aria-label":h?"Hide password":"Show password",title:h?"Hide password":"Show password",children:h?"Hide":"Show"})]})]}),c.jsxs("div",{className:"form-group",children:[c.jsx("label",{htmlFor:"confirm",children:"Confirm Password"}),c.jsxs("div",{className:"password-field",children:[c.jsx("input",{id:"confirm",type:m?"text":"password",name:"confirm",placeholder:"********",value:s.confirm,onChange:g,autoComplete:"new-password",required:!0}),c.jsx("button",{type:"button",className:"password-toggle",onClick:()=>f(e=>!e),"aria-label":m?"Hide confirm password":"Show confirm password",title:m?"Hide confirm password":"Show confirm password",children:m?"Hide":"Show"})]})]}),o&&c.jsx("div",{className:"error-message",children:o}),c.jsxs("button",{type:"submit",disabled:d,className:"submit-btn",children:[d?c.jsx("span",{className:"spinner"}):null,d?"Creating account...":"Sign Up"]}),c.jsxs("p",{className:"auth-switch",children:["Already have an account? ",c.jsx("button",{type:"button",className:"auth-switch-btn",onClick:t,children:"Login"})]})]})})}const T=Object.create(null);T.open="0",T.close="1",T.ping="2",T.pong="3",T.message="4",T.upgrade="5",T.noop="6";const A=Object.create(null);Object.keys(T).forEach(e=>{A[T[e]]=e});const I={type:"error",data:"parser error"},P="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===Object.prototype.toString.call(Blob),M="function"==typeof ArrayBuffer,O=e=>"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer instanceof ArrayBuffer,U=({type:e,data:t},r,n)=>P&&t instanceof Blob?r?n(t):D(t,n):M&&(t instanceof ArrayBuffer||O(t))?r?n(t):D(new Blob([t]),n):n(T[e]+(t||"")),D=(e,t)=>{const r=new FileReader;return r.onload=function(){const e=r.result.split(",")[1];t("b"+(e||""))},r.readAsDataURL(e)};function L(e){return e instanceof Uint8Array?e:e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e.buffer,e.byteOffset,e.byteLength)}let B;const z="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",$="undefined"==typeof Uint8Array?[]:new Uint8Array(256);for(let Zr=0;Zr<64;Zr++)$[z.charCodeAt(Zr)]=Zr;const F="function"==typeof ArrayBuffer,q=(e,t)=>{if("string"!=typeof e)return{type:"message",data:K(e,t)};const r=e.charAt(0);if("b"===r)return{type:"message",data:W(e.substring(1),t)};return A[r]?e.length>1?{type:A[r],data:e.substring(1)}:{type:A[r]}:I},W=(e,t)=>{if(F){const r=(e=>{let t,r,n,s,i,o=.75*e.length,a=e.length,c=0;"="===e[e.length-1]&&(o--,"="===e[e.length-2]&&o--);const l=new ArrayBuffer(o),d=new Uint8Array(l);for(t=0;t<a;t+=4)r=$[e.charCodeAt(t)],n=$[e.charCodeAt(t+1)],s=$[e.charCodeAt(t+2)],i=$[e.charCodeAt(t+3)],d[c++]=r<<2|n>>4,d[c++]=(15&n)<<4|s>>2,d[c++]=(3&s)<<6|63&i;return l})(e);return K(r,t)}return{base64:!0,data:e}},K=(e,t)=>"blob"===t?e instanceof Blob?e:new Blob([e]):e instanceof ArrayBuffer?e:e.buffer,V=String.fromCharCode(30);function H(){return new TransformStream({transform(e,t){!function(e,t){P&&e.data instanceof Blob?e.data.arrayBuffer().then(L).then(t):M&&(e.data instanceof ArrayBuffer||O(e.data))?t(L(e.data)):U(e,!1,e=>{B||(B=new TextEncoder),t(B.encode(e))})}(e,r=>{const n=r.length;let s;if(n<126)s=new Uint8Array(1),new DataView(s.buffer).setUint8(0,n);else if(n<65536){s=new Uint8Array(3);const e=new DataView(s.buffer);e.setUint8(0,126),e.setUint16(1,n)}else{s=new Uint8Array(9);const e=new DataView(s.buffer);e.setUint8(0,127),e.setBigUint64(1,BigInt(n))}e.data&&"string"!=typeof e.data&&(s[0]|=128),t.enqueue(s),t.enqueue(r)})}})}let Y;function Z(e){return e.reduce((e,t)=>e+t.length,0)}function J(e,t){if(e[0].length===t)return e.shift();const r=new Uint8Array(t);let n=0;for(let s=0;s<t;s++)r[s]=e[0][n++],n===e[0].length&&(e.shift(),n=0);return e.length&&n<e[0].length&&(e[0]=e[0].slice(n)),r}function G(e){if(e)return function(e){for(var t in G.prototype)e[t]=G.prototype[t];return e}(e)}G.prototype.on=G.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks["$"+e]=this._callbacks["$"+e]||[]).push(t),this},G.prototype.once=function(e,t){function r(){this.off(e,r),t.apply(this,arguments)}return r.fn=t,this.on(e,r),this},G.prototype.off=G.prototype.removeListener=G.prototype.removeAllListeners=G.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var r,n=this._callbacks["$"+e];if(!n)return this;if(1==arguments.length)return delete this._callbacks["$"+e],this;for(var s=0;s<n.length;s++)if((r=n[s])===t||r.fn===t){n.splice(s,1);break}return 0===n.length&&delete this._callbacks["$"+e],this},G.prototype.emit=function(e){this._callbacks=this._callbacks||{};for(var t=new Array(arguments.length-1),r=this._callbacks["$"+e],n=1;n<arguments.length;n++)t[n-1]=arguments[n];if(r){n=0;for(var s=(r=r.slice(0)).length;n<s;++n)r[n].apply(this,t)}return this},G.prototype.emitReserved=G.prototype.emit,G.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks["$"+e]||[]},G.prototype.hasListeners=function(e){return!!this.listeners(e).length};const X="function"==typeof Promise&&"function"==typeof Promise.resolve?e=>Promise.resolve().then(e):(e,t)=>t(e,0),Q="undefined"!=typeof self?self:"undefined"!=typeof window?window:Function("return this")();function ee(e,...t){return t.reduce((t,r)=>(e.hasOwnProperty(r)&&(t[r]=e[r]),t),{})}const te=Q.setTimeout,re=Q.clearTimeout;function ne(e,t){t.useNativeTimers?(e.setTimeoutFn=te.bind(Q),e.clearTimeoutFn=re.bind(Q)):(e.setTimeoutFn=Q.setTimeout.bind(Q),e.clearTimeoutFn=Q.clearTimeout.bind(Q))}function se(e){return"string"==typeof e?function(e){let t=0,r=0;for(let n=0,s=e.length;n<s;n++)t=e.charCodeAt(n),t<128?r+=1:t<2048?r+=2:t<55296||t>=57344?r+=3:(n++,r+=4);return r}(e):Math.ceil(1.33*(e.byteLength||e.size))}function ie(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}class oe extends Error{constructor(e,t,r){super(e),this.description=t,this.context=r,this.type="TransportError"}}class ae extends G{constructor(e){super(),this.writable=!1,ne(this,e),this.opts=e,this.query=e.query,this.socket=e.socket,this.supportsBinary=!e.forceBase64}onError(e,t,r){return super.emitReserved("error",new oe(e,t,r)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return"opening"!==this.readyState&&"open"!==this.readyState||(this.doClose(),this.onClose()),this}send(e){"open"===this.readyState&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){const t=q(e,this.socket.binaryType);this.onPacket(t)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}createUri(e,t={}){return e+"://"+this._hostname()+this._port()+this.opts.path+this._query(t)}_hostname(){const e=this.opts.hostname;return-1===e.indexOf(":")?e:"["+e+"]"}_port(){return this.opts.port&&(this.opts.secure&&443!==Number(this.opts.port)||!this.opts.secure&&80!==Number(this.opts.port))?":"+this.opts.port:""}_query(e){const t=function(e){let t="";for(let r in e)e.hasOwnProperty(r)&&(t.length&&(t+="&"),t+=encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return t}(e);return t.length?"?"+t:""}}class ce extends ae{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(e){this.readyState="pausing";const t=()=>{this.readyState="paused",e()};if(this._polling||!this.writable){let e=0;this._polling&&(e++,this.once("pollComplete",function(){--e||t()})),this.writable||(e++,this.once("drain",function(){--e||t()}))}else t()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){((e,t)=>{const r=e.split(V),n=[];for(let s=0;s<r.length;s++){const e=q(r[s],t);if(n.push(e),"error"===e.type)break}return n})(e,this.socket.binaryType).forEach(e=>{if("opening"===this.readyState&&"open"===e.type&&this.onOpen(),"close"===e.type)return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(e)}),"closed"!==this.readyState&&(this._polling=!1,this.emitReserved("pollComplete"),"open"===this.readyState&&this._poll())}doClose(){const e=()=>{this.write([{type:"close"}])};"open"===this.readyState?e():this.once("open",e)}write(e){this.writable=!1,((e,t)=>{const r=e.length,n=new Array(r);let s=0;e.forEach((e,i)=>{U(e,!1,e=>{n[i]=e,++s===r&&t(n.join(V))})})})(e,e=>{this.doWrite(e,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){const e=this.opts.secure?"https":"http",t=this.query||{};return!1!==this.opts.timestampRequests&&(t[this.opts.timestampParam]=ie()),this.supportsBinary||t.sid||(t.b64=1),this.createUri(e,t)}}let le=!1;try{le="undefined"!=typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest}catch(Yr){}const de=le;function ue(){}class he extends ce{constructor(e){if(super(e),"undefined"!=typeof location){const t="https:"===location.protocol;let r=location.port;r||(r=t?"443":"80"),this.xd="undefined"!=typeof location&&e.hostname!==location.hostname||r!==e.port}}doWrite(e,t){const r=this.request({method:"POST",data:e});r.on("success",t),r.on("error",(e,t)=>{this.onError("xhr post error",e,t)})}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",(e,t)=>{this.onError("xhr poll error",e,t)}),this.pollXhr=e}}class pe extends G{constructor(e,t,r){super(),this.createRequest=e,ne(this,r),this._opts=r,this._method=r.method||"GET",this._uri=t,this._data=void 0!==r.data?r.data:null,this._create()}_create(){var e;const t=ee(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");t.xdomain=!!this._opts.xd;const r=this._xhr=this.createRequest(t);try{r.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){r.setDisableHeaderCheck&&r.setDisableHeaderCheck(!0);for(let e in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(e)&&r.setRequestHeader(e,this._opts.extraHeaders[e])}}catch(n){}if("POST"===this._method)try{r.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(n){}try{r.setRequestHeader("Accept","*/*")}catch(n){}null===(e=this._opts.cookieJar)||void 0===e||e.addCookies(r),"withCredentials"in r&&(r.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(r.timeout=this._opts.requestTimeout),r.onreadystatechange=()=>{var e;3===r.readyState&&(null===(e=this._opts.cookieJar)||void 0===e||e.parseCookies(r.getResponseHeader("set-cookie"))),4===r.readyState&&(200===r.status||1223===r.status?this._onLoad():this.setTimeoutFn(()=>{this._onError("number"==typeof r.status?r.status:0)},0))},r.send(this._data)}catch(n){return void this.setTimeoutFn(()=>{this._onError(n)},0)}"undefined"!=typeof document&&(this._index=pe.requestsCount++,pe.requests[this._index]=this)}_onError(e){this.emitReserved("error",e,this._xhr),this._cleanup(!0)}_cleanup(e){if(void 0!==this._xhr&&null!==this._xhr){if(this._xhr.onreadystatechange=ue,e)try{this._xhr.abort()}catch(t){}"undefined"!=typeof document&&delete pe.requests[this._index],this._xhr=null}}_onLoad(){const e=this._xhr.responseText;null!==e&&(this.emitReserved("data",e),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}if(pe.requestsCount=0,pe.requests={},"undefined"!=typeof document)if("function"==typeof attachEvent)attachEvent("onunload",me);else if("function"==typeof addEventListener){addEventListener("onpagehide"in Q?"pagehide":"unload",me,!1)}function me(){for(let e in pe.requests)pe.requests.hasOwnProperty(e)&&pe.requests[e].abort()}const fe=function(){const e=ge({xdomain:!1});return e&&null!==e.responseType}();function ge(e){const t=e.xdomain;try{if("undefined"!=typeof XMLHttpRequest&&(!t||de))return new XMLHttpRequest}catch(r){}if(!t)try{return new(Q[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(r){}}const ye="undefined"!=typeof navigator&&"string"==typeof navigator.product&&"reactnative"===navigator.product.toLowerCase();class ve extends ae{get name(){return"websocket"}doOpen(){const e=this.uri(),t=this.opts.protocols,r=ye?{}:ee(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(r.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(e,t,r)}catch(Yr){return this.emitReserved("error",Yr)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const r=e[t],n=t===e.length-1;U(r,this.supportsBinary,e=>{try{this.doWrite(r,e)}catch(t){}n&&X(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){void 0!==this.ws&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const e=this.opts.secure?"wss":"ws",t=this.query||{};return this.opts.timestampRequests&&(t[this.opts.timestampParam]=ie()),this.supportsBinary||(t.b64=1),this.createUri(e,t)}}const be=Q.WebSocket||Q.MozWebSocket;const we={websocket:class extends ve{createSocket(e,t,r){return ye?new be(e,t,r):t?new be(e,t):new be(e)}doWrite(e,t){this.ws.send(t)}},webtransport:class extends ae{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(Yr){return this.emitReserved("error",Yr)}this._transport.closed.then(()=>{this.onClose()}).catch(e=>{this.onError("webtransport error",e)}),this._transport.ready.then(()=>{this._transport.createBidirectionalStream().then(e=>{const t=function(e,t){Y||(Y=new TextDecoder);const r=[];let n=0,s=-1,i=!1;return new TransformStream({transform(o,a){for(r.push(o);;){if(0===n){if(Z(r)<1)break;const e=J(r,1);i=!(128&~e[0]),s=127&e[0],n=s<126?3:126===s?1:2}else if(1===n){if(Z(r)<2)break;const e=J(r,2);s=new DataView(e.buffer,e.byteOffset,e.length).getUint16(0),n=3}else if(2===n){if(Z(r)<8)break;const e=J(r,8),t=new DataView(e.buffer,e.byteOffset,e.length),i=t.getUint32(0);if(i>Math.pow(2,21)-1){a.enqueue(I);break}s=i*Math.pow(2,32)+t.getUint32(4),n=3}else{if(Z(r)<s)break;const e=J(r,s);a.enqueue(q(i?e:Y.decode(e),t)),n=0}if(0===s||s>e){a.enqueue(I);break}}}})}(Number.MAX_SAFE_INTEGER,this.socket.binaryType),r=e.readable.pipeThrough(t).getReader(),n=H();n.readable.pipeTo(e.writable),this._writer=n.writable.getWriter();const s=()=>{r.read().then(({done:e,value:t})=>{e||(this.onPacket(t),s())}).catch(e=>{})};s();const i={type:"open"};this.query.sid&&(i.data=`{"sid":"${this.query.sid}"}`),this._writer.write(i).then(()=>this.onOpen())})})}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const r=e[t],n=t===e.length-1;this._writer.write(r).then(()=>{n&&X(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var e;null===(e=this._transport)||void 0===e||e.close()}},polling:class extends he{constructor(e){super(e);const t=e&&e.forceBase64;this.supportsBinary=fe&&!t}request(e={}){return Object.assign(e,{xd:this.xd},this.opts),new pe(ge,this.uri(),e)}}},xe=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,Se=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function je(e){if(e.length>8e3)throw"URI too long";const t=e,r=e.indexOf("["),n=e.indexOf("]");-1!=r&&-1!=n&&(e=e.substring(0,r)+e.substring(r,n).replace(/:/g,";")+e.substring(n,e.length));let s=xe.exec(e||""),i={},o=14;for(;o--;)i[Se[o]]=s[o]||"";return-1!=r&&-1!=n&&(i.source=t,i.host=i.host.substring(1,i.host.length-1).replace(/;/g,":"),i.authority=i.authority.replace("[","").replace("]","").replace(/;/g,":"),i.ipv6uri=!0),i.pathNames=function(e,t){const r=/\/{2,9}/g,n=t.replace(r,"/").split("/");"/"!=t.slice(0,1)&&0!==t.length||n.splice(0,1);"/"==t.slice(-1)&&n.splice(n.length-1,1);return n}(0,i.path),i.queryKey=function(e,t){const r={};return t.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(e,t,n){t&&(r[t]=n)}),r}(0,i.query),i}const Ce="function"==typeof addEventListener&&"function"==typeof removeEventListener,_e=[];Ce&&addEventListener("offline",()=>{_e.forEach(e=>e())},!1);class ke extends G{constructor(e,t){if(super(),this.binaryType="arraybuffer",this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,e&&"object"==typeof e&&(t=e,e=null),e){const r=je(e);t.hostname=r.host,t.secure="https"===r.protocol||"wss"===r.protocol,t.port=r.port,r.query&&(t.query=r.query)}else t.host&&(t.hostname=je(t.host).host);ne(this,t),this.secure=null!=t.secure?t.secure:"undefined"!=typeof location&&"https:"===location.protocol,t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||("undefined"!=typeof location?location.hostname:"localhost"),this.port=t.port||("undefined"!=typeof location&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},t.transports.forEach(e=>{const t=e.prototype.name;this.transports.push(t),this._transportsByName[t]=e}),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},t),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),"string"==typeof this.opts.query&&(this.opts.query=function(e){let t={},r=e.split("&");for(let n=0,s=r.length;n<s;n++){let e=r[n].split("=");t[decodeURIComponent(e[0])]=decodeURIComponent(e[1])}return t}(this.opts.query)),Ce&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),"localhost"!==this.hostname&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},_e.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(e){const t=Object.assign({},this.opts.query);t.EIO=4,t.transport=e,this.id&&(t.sid=this.id);const r=Object.assign({},this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[e]);return new this._transportsByName[e](r)}_open(){if(0===this.transports.length)return void this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);const e=this.opts.rememberUpgrade&&ke.priorWebsocketSuccess&&-1!==this.transports.indexOf("websocket")?"websocket":this.transports[0];this.readyState="opening";const t=this.createTransport(e);t.open(),this.setTransport(t)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",e=>this._onClose("transport close",e))}onOpen(){this.readyState="open",ke.priorWebsocketSuccess="websocket"===this.transport.name,this.emitReserved("open"),this.flush()}_onPacket(e){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState)switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const t=new Error("server error");t.code=e.data,this._onError(t);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data)}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this._pingInterval=e.pingInterval,this._pingTimeout=e.pingTimeout,this._maxPayload=e.maxPayload,this.onOpen(),"closed"!==this.readyState&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const e=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+e,this._pingTimeoutTimer=this.setTimeoutFn(()=>{this._onClose("ping timeout")},e),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,0===this.writeBuffer.length?this.emitReserved("drain"):this.flush()}flush(){if("closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const e=this._getWritablePackets();this.transport.send(e),this._prevBufferLen=e.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&"polling"===this.transport.name&&this.writeBuffer.length>1))return this.writeBuffer;let e=1;for(let t=0;t<this.writeBuffer.length;t++){const r=this.writeBuffer[t].data;if(r&&(e+=se(r)),t>0&&e>this._maxPayload)return this.writeBuffer.slice(0,t);e+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const e=Date.now()>this._pingTimeoutTime;return e&&(this._pingTimeoutTime=0,X(()=>{this._onClose("ping timeout")},this.setTimeoutFn)),e}write(e,t,r){return this._sendPacket("message",e,t,r),this}send(e,t,r){return this._sendPacket("message",e,t,r),this}_sendPacket(e,t,r,n){if("function"==typeof t&&(n=t,t=void 0),"function"==typeof r&&(n=r,r=null),"closing"===this.readyState||"closed"===this.readyState)return;(r=r||{}).compress=!1!==r.compress;const s={type:e,data:t,options:r};this.emitReserved("packetCreate",s),this.writeBuffer.push(s),n&&this.once("flush",n),this.flush()}close(){const e=()=>{this._onClose("forced close"),this.transport.close()},t=()=>{this.off("upgrade",t),this.off("upgradeError",t),e()},r=()=>{this.once("upgrade",t),this.once("upgradeError",t)};return"opening"!==this.readyState&&"open"!==this.readyState||(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?r():e()}):this.upgrading?r():e()),this}_onError(e){if(ke.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&"opening"===this.readyState)return this.transports.shift(),this._open();this.emitReserved("error",e),this._onClose("transport error",e)}_onClose(e,t){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),Ce&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const e=_e.indexOf(this._offlineEventListener);-1!==e&&_e.splice(e,1)}this.readyState="closed",this.id=null,this.emitReserved("close",e,t),this.writeBuffer=[],this._prevBufferLen=0}}}ke.protocol=4;class Ne extends ke{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),"open"===this.readyState&&this.opts.upgrade)for(let e=0;e<this._upgrades.length;e++)this._probe(this._upgrades[e])}_probe(e){let t=this.createTransport(e),r=!1;ke.priorWebsocketSuccess=!1;const n=()=>{r||(t.send([{type:"ping",data:"probe"}]),t.once("packet",e=>{if(!r)if("pong"===e.type&&"probe"===e.data){if(this.upgrading=!0,this.emitReserved("upgrading",t),!t)return;ke.priorWebsocketSuccess="websocket"===t.name,this.transport.pause(()=>{r||"closed"!==this.readyState&&(l(),this.setTransport(t),t.send([{type:"upgrade"}]),this.emitReserved("upgrade",t),t=null,this.upgrading=!1,this.flush())})}else{const e=new Error("probe error");e.transport=t.name,this.emitReserved("upgradeError",e)}}))};function s(){r||(r=!0,l(),t.close(),t=null)}const i=e=>{const r=new Error("probe error: "+e);r.transport=t.name,s(),this.emitReserved("upgradeError",r)};function o(){i("transport closed")}function a(){i("socket closed")}function c(e){t&&e.name!==t.name&&s()}const l=()=>{t.removeListener("open",n),t.removeListener("error",i),t.removeListener("close",o),this.off("close",a),this.off("upgrading",c)};t.once("open",n),t.once("error",i),t.once("close",o),this.once("close",a),this.once("upgrading",c),-1!==this._upgrades.indexOf("webtransport")&&"webtransport"!==e?this.setTimeoutFn(()=>{r||t.open()},200):t.open()}onHandshake(e){this._upgrades=this._filterUpgrades(e.upgrades),super.onHandshake(e)}_filterUpgrades(e){const t=[];for(let r=0;r<e.length;r++)~this.transports.indexOf(e[r])&&t.push(e[r]);return t}}let Ee=class extends Ne{constructor(e,t={}){const r="object"==typeof e?e:t;(!r.transports||r.transports&&"string"==typeof r.transports[0])&&(r.transports=(r.transports||["polling","websocket","webtransport"]).map(e=>we[e]).filter(e=>!!e)),super(e,r)}};const Re="function"==typeof ArrayBuffer,Te=Object.prototype.toString,Ae="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===Te.call(Blob),Ie="function"==typeof File||"undefined"!=typeof File&&"[object FileConstructor]"===Te.call(File);function Pe(e){return Re&&(e instanceof ArrayBuffer||(e=>"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(e):e.buffer instanceof ArrayBuffer)(e))||Ae&&e instanceof Blob||Ie&&e instanceof File}function Me(e,t){if(!e||"object"!=typeof e)return!1;if(Array.isArray(e)){for(let t=0,r=e.length;t<r;t++)if(Me(e[t]))return!0;return!1}if(Pe(e))return!0;if(e.toJSON&&"function"==typeof e.toJSON&&1===arguments.length)return Me(e.toJSON(),!0);for(const r in e)if(Object.prototype.hasOwnProperty.call(e,r)&&Me(e[r]))return!0;return!1}function Oe(e){const t=[],r=e.data,n=e;return n.data=Ue(r,t),n.attachments=t.length,{packet:n,buffers:t}}function Ue(e,t){if(!e)return e;if(Pe(e)){const r={_placeholder:!0,num:t.length};return t.push(e),r}if(Array.isArray(e)){const r=new Array(e.length);for(let n=0;n<e.length;n++)r[n]=Ue(e[n],t);return r}if("object"==typeof e&&!(e instanceof Date)){const r={};for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&(r[n]=Ue(e[n],t));return r}return e}function De(e,t){return e.data=Le(e.data,t),delete e.attachments,e}function Le(e,t){if(!e)return e;if(e&&!0===e._placeholder){if("number"==typeof e.num&&e.num>=0&&e.num<t.length)return t[e.num];throw new Error("illegal attachments")}if(Array.isArray(e))for(let r=0;r<e.length;r++)e[r]=Le(e[r],t);else if("object"==typeof e)for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&(e[r]=Le(e[r],t));return e}const Be=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"];var ze,$e;($e=ze||(ze={}))[$e.CONNECT=0]="CONNECT",$e[$e.DISCONNECT=1]="DISCONNECT",$e[$e.EVENT=2]="EVENT",$e[$e.ACK=3]="ACK",$e[$e.CONNECT_ERROR=4]="CONNECT_ERROR",$e[$e.BINARY_EVENT=5]="BINARY_EVENT",$e[$e.BINARY_ACK=6]="BINARY_ACK";class Fe extends G{constructor(e){super(),this.reviver=e}add(e){let t;if("string"==typeof e){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");t=this.decodeString(e);const r=t.type===ze.BINARY_EVENT;r||t.type===ze.BINARY_ACK?(t.type=r?ze.EVENT:ze.ACK,this.reconstructor=new qe(t),0===t.attachments&&super.emitReserved("decoded",t)):super.emitReserved("decoded",t)}else{if(!Pe(e)&&!e.base64)throw new Error("Unknown type: "+e);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emitReserved("decoded",t))}}decodeString(e){let t=0;const r={type:Number(e.charAt(0))};if(void 0===ze[r.type])throw new Error("unknown packet type "+r.type);if(r.type===ze.BINARY_EVENT||r.type===ze.BINARY_ACK){const n=t+1;for(;"-"!==e.charAt(++t)&&t!=e.length;);const s=e.substring(n,t);if(s!=Number(s)||"-"!==e.charAt(t))throw new Error("Illegal attachments");r.attachments=Number(s)}if("/"===e.charAt(t+1)){const n=t+1;for(;++t;){if(","===e.charAt(t))break;if(t===e.length)break}r.nsp=e.substring(n,t)}else r.nsp="/";const n=e.charAt(t+1);if(""!==n&&Number(n)==n){const n=t+1;for(;++t;){const r=e.charAt(t);if(null==r||Number(r)!=r){--t;break}if(t===e.length)break}r.id=Number(e.substring(n,t+1))}if(e.charAt(++t)){const n=this.tryParse(e.substr(t));if(!Fe.isPayloadValid(r.type,n))throw new Error("invalid payload");r.data=n}return r}tryParse(e){try{return JSON.parse(e,this.reviver)}catch(t){return!1}}static isPayloadValid(e,t){switch(e){case ze.CONNECT:return Ke(t);case ze.DISCONNECT:return void 0===t;case ze.CONNECT_ERROR:return"string"==typeof t||Ke(t);case ze.EVENT:case ze.BINARY_EVENT:return Array.isArray(t)&&("number"==typeof t[0]||"string"==typeof t[0]&&-1===Be.indexOf(t[0]));case ze.ACK:case ze.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class qe{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const e=De(this.reconPack,this.buffers);return this.finishedReconstruction(),e}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}const We=Number.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e};function Ke(e){return"[object Object]"===Object.prototype.toString.call(e)}const Ve=Object.freeze(Object.defineProperty({__proto__:null,Decoder:Fe,Encoder:class{constructor(e){this.replacer=e}encode(e){return e.type!==ze.EVENT&&e.type!==ze.ACK||!Me(e)?[this.encodeAsString(e)]:this.encodeAsBinary({type:e.type===ze.EVENT?ze.BINARY_EVENT:ze.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id})}encodeAsString(e){let t=""+e.type;return e.type!==ze.BINARY_EVENT&&e.type!==ze.BINARY_ACK||(t+=e.attachments+"-"),e.nsp&&"/"!==e.nsp&&(t+=e.nsp+","),null!=e.id&&(t+=e.id),null!=e.data&&(t+=JSON.stringify(e.data,this.replacer)),t}encodeAsBinary(e){const t=Oe(e),r=this.encodeAsString(t.packet),n=t.buffers;return n.unshift(r),n}},get PacketType(){return ze},isPacketValid:function(e){return"string"==typeof e.nsp&&(void 0===(t=e.id)||We(t))&&function(e,t){switch(e){case ze.CONNECT:return void 0===t||Ke(t);case ze.DISCONNECT:return void 0===t;case ze.EVENT:return Array.isArray(t)&&("number"==typeof t[0]||"string"==typeof t[0]&&-1===Be.indexOf(t[0]));case ze.ACK:return Array.isArray(t);case ze.CONNECT_ERROR:return"string"==typeof t||Ke(t);default:return!1}}(e.type,e.data);var t},protocol:5},Symbol.toStringTag,{value:"Module"}));function He(e,t,r){return e.on(t,r),function(){e.off(t,r)}}const Ye=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class Ze extends G{constructor(e,t,r){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,r&&r.auth&&(this.auth=r.auth),this._opts=Object.assign({},r),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const e=this.io;this.subs=[He(e,"open",this.onopen.bind(this)),He(e,"packet",this.onpacket.bind(this)),He(e,"error",this.onerror.bind(this)),He(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected||(this.subEvents(),this.io._reconnecting||this.io.open(),"open"===this.io._readyState&&this.onopen()),this}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...t){var r,n,s;if(Ye.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');if(t.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(t),this;const i={type:ze.EVENT,data:t,options:{}};if(i.options.compress=!1!==this.flags.compress,"function"==typeof t[t.length-1]){const e=this.ids++,r=t.pop();this._registerAckCallback(e,r),i.id=e}const o=null===(n=null===(r=this.io.engine)||void 0===r?void 0:r.transport)||void 0===n?void 0:n.writable,a=this.connected&&!(null===(s=this.io.engine)||void 0===s?void 0:s._hasPingExpired());return this.flags.volatile&&!o||(a?(this.notifyOutgoingListeners(i),this.packet(i)):this.sendBuffer.push(i)),this.flags={},this}_registerAckCallback(e,t){var r;const n=null!==(r=this.flags.timeout)&&void 0!==r?r:this._opts.ackTimeout;if(void 0===n)return void(this.acks[e]=t);const s=this.io.setTimeoutFn(()=>{delete this.acks[e];for(let t=0;t<this.sendBuffer.length;t++)this.sendBuffer[t].id===e&&this.sendBuffer.splice(t,1);t.call(this,new Error("operation has timed out"))},n),i=(...e)=>{this.io.clearTimeoutFn(s),t.apply(this,e)};i.withError=!0,this.acks[e]=i}emitWithAck(e,...t){return new Promise((r,n)=>{const s=(e,t)=>e?n(e):r(t);s.withError=!0,t.push(s),this.emit(e,...t)})}_addToQueue(e){let t;"function"==typeof e[e.length-1]&&(t=e.pop());const r={id:this._queueSeq++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push((e,...n)=>{this._queue[0];return null!==e?r.tryCount>this._opts.retries&&(this._queue.shift(),t&&t(e)):(this._queue.shift(),t&&t(null,...n)),r.pending=!1,this._drainQueue()}),this._queue.push(r),this._drainQueue()}_drainQueue(e=!1){if(!this.connected||0===this._queue.length)return;const t=this._queue[0];t.pending&&!e||(t.pending=!0,t.tryCount++,this.flags=t.flags,this.emit.apply(this,t.args))}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){"function"==typeof this.auth?this.auth(e=>{this._sendConnectPacket(e)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:ze.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,t){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,t),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(e=>{if(!this.sendBuffer.some(t=>String(t.id)===e)){const t=this.acks[e];delete this.acks[e],t.withError&&t.call(this,new Error("socket has been disconnected"))}})}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case ze.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case ze.EVENT:case ze.BINARY_EVENT:this.onevent(e);break;case ze.ACK:case ze.BINARY_ACK:this.onack(e);break;case ze.DISCONNECT:this.ondisconnect();break;case ze.CONNECT_ERROR:this.destroy();const t=new Error(e.data.message);t.data=e.data.data,this.emitReserved("connect_error",t)}}onevent(e){const t=e.data||[];null!=e.id&&t.push(this.ack(e.id)),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const t=this._anyListeners.slice();for(const r of t)r.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&"string"==typeof e[e.length-1]&&(this._lastOffset=e[e.length-1])}ack(e){const t=this;let r=!1;return function(...n){r||(r=!0,t.packet({type:ze.ACK,id:e,data:n}))}}onack(e){const t=this.acks[e.id];"function"==typeof t&&(delete this.acks[e.id],t.withError&&e.data.unshift(null),t.apply(this,e.data))}onconnect(e,t){this.id=e,this.recovered=t&&this._pid===t,this._pid=t,this.connected=!0,this.emitBuffered(),this._drainQueue(!0),this.emitReserved("connect")}emitBuffered(){this.receiveBuffer.forEach(e=>this.emitEvent(e)),this.receiveBuffer=[],this.sendBuffer.forEach(e=>{this.notifyOutgoingListeners(e),this.packet(e)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(e=>e()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:ze.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const t=this._anyListeners;for(let r=0;r<t.length;r++)if(e===t[r])return t.splice(r,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){const t=this._anyOutgoingListeners;for(let r=0;r<t.length;r++)if(e===t[r])return t.splice(r,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const t=this._anyOutgoingListeners.slice();for(const r of t)r.apply(this,e.data)}}}function Je(e){e=e||{},this.ms=e.min||100,this.max=e.max||1e4,this.factor=e.factor||2,this.jitter=e.jitter>0&&e.jitter<=1?e.jitter:0,this.attempts=0}Je.prototype.duration=function(){var e=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var t=Math.random(),r=Math.floor(t*this.jitter*e);e=1&Math.floor(10*t)?e+r:e-r}return 0|Math.min(e,this.max)},Je.prototype.reset=function(){this.attempts=0},Je.prototype.setMin=function(e){this.ms=e},Je.prototype.setMax=function(e){this.max=e},Je.prototype.setJitter=function(e){this.jitter=e};class Ge extends G{constructor(e,t){var r;super(),this.nsps={},this.subs=[],e&&"object"==typeof e&&(t=e,e=void 0),(t=t||{}).path=t.path||"/socket.io",this.opts=t,ne(this,t),this.reconnection(!1!==t.reconnection),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor(null!==(r=t.randomizationFactor)&&void 0!==r?r:.5),this.backoff=new Je({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==t.timeout?2e4:t.timeout),this._readyState="closed",this.uri=e;const n=t.parser||Ve;this.encoder=new n.Encoder,this.decoder=new n.Decoder,this._autoConnect=!1!==t.autoConnect,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,e||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(e){return void 0===e?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return void 0===e?this._reconnectionDelay:(this._reconnectionDelay=e,null===(t=this.backoff)||void 0===t||t.setMin(e),this)}randomizationFactor(e){var t;return void 0===e?this._randomizationFactor:(this._randomizationFactor=e,null===(t=this.backoff)||void 0===t||t.setJitter(e),this)}reconnectionDelayMax(e){var t;return void 0===e?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,null===(t=this.backoff)||void 0===t||t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new Ee(this.uri,this.opts);const t=this.engine,r=this;this._readyState="opening",this.skipReconnect=!1;const n=He(t,"open",function(){r.onopen(),e&&e()}),s=t=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",t),e?e(t):this.maybeReconnectOnOpen()},i=He(t,"error",s);if(!1!==this._timeout){const e=this._timeout,r=this.setTimeoutFn(()=>{n(),s(new Error("timeout")),t.close()},e);this.opts.autoUnref&&r.unref(),this.subs.push(()=>{this.clearTimeoutFn(r)})}return this.subs.push(n),this.subs.push(i),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const e=this.engine;this.subs.push(He(e,"ping",this.onping.bind(this)),He(e,"data",this.ondata.bind(this)),He(e,"error",this.onerror.bind(this)),He(e,"close",this.onclose.bind(this)),He(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(t){this.onclose("parse error",t)}}ondecoded(e){X(()=>{this.emitReserved("packet",e)},this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,t){let r=this.nsps[e];return r?this._autoConnect&&!r.active&&r.connect():(r=new Ze(this,e,t),this.nsps[e]=r),r}_destroy(e){const t=Object.keys(this.nsps);for(const r of t){if(this.nsps[r].active)return}this._close()}_packet(e){const t=this.encoder.encode(e);for(let r=0;r<t.length;r++)this.engine.write(t[r],e.options)}cleanup(){this.subs.forEach(e=>e()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(e,t){var r;this.cleanup(),null===(r=this.engine)||void 0===r||r.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,t),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const t=this.backoff.duration();this._reconnecting=!0;const r=this.setTimeoutFn(()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),e.skipReconnect||e.open(t=>{t?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",t)):e.onreconnect()}))},t);this.opts.autoUnref&&r.unref(),this.subs.push(()=>{this.clearTimeoutFn(r)})}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}const Xe={};function Qe(e,t){"object"==typeof e&&(t=e,e=void 0);const r=function(e,t="",r){let n=e;r=r||"undefined"!=typeof location&&location,null==e&&(e=r.protocol+"//"+r.host),"string"==typeof e&&("/"===e.charAt(0)&&(e="/"===e.charAt(1)?r.protocol+e:r.host+e),/^(https?|wss?):\/\//.test(e)||(e=void 0!==r?r.protocol+"//"+e:"https://"+e),n=je(e)),n.port||(/^(http|ws)$/.test(n.protocol)?n.port="80":/^(http|ws)s$/.test(n.protocol)&&(n.port="443")),n.path=n.path||"/";const s=-1!==n.host.indexOf(":")?"["+n.host+"]":n.host;return n.id=n.protocol+"://"+s+":"+n.port+t,n.href=n.protocol+"://"+s+(r&&r.port===n.port?"":":"+n.port),n}(e,(t=t||{}).path||"/socket.io"),n=r.source,s=r.id,i=r.path,o=Xe[s]&&i in Xe[s].nsps;let a;return t.forceNew||t["force new connection"]||!1===t.multiplex||o?a=new Ge(n,t):(Xe[s]||(Xe[s]=new Ge(n,t)),a=Xe[s]),r.query&&!t.query&&(t.query=r.queryKey),a.socket(r.path,t)}Object.assign(Qe,{Manager:Ge,Socket:Ze,io:Qe,connect:Qe});const et="https://real-time-chatapp-o0me.onrender.com".replace(/\/$/,"");function tt({currentUserId:e,onRequestStatusChange:t}){const[r,s]=l.useState([]),[i,o]=l.useState([]),[a,d]=l.useState("received"),[u,h]=l.useState(!1),[p,m]=l.useState(""),f=()=>{const{token:e}=k();return e?{timeout:8e3,headers:{Authorization:`Bearer ${e}`}}:{timeout:8e3}},g=l.useCallback(async()=>{if(!e)return s([]),o([]),void m("");h(!0),m("");try{const t=await n.get(`${et}/api/users/${e}/follow-info`,f());s(t.data?.receivedRequests||[]),o(t.data?.sentRequests||[])}catch(Yr){console.error("Error fetching requests:",Yr);const t=Yr.response?.status,r=Yr.response?.data?.message;m(r?`${r}${t?` (status ${t})`:""}`:"Failed to load requests")}finally{h(!1)}},[e]);l.useEffect(()=>{if(!e)return;g();const t=setInterval(g,5e3);return()=>clearInterval(t)},[e,g]);return c.jsxs("div",{className:"friend-requests-container",children:[c.jsxs("div",{className:"tabs",children:[c.jsxs("button",{className:"tab-btn "+("received"===a?"active":""),onClick:()=>d("received"),children:["Received (",r.length,")"]}),c.jsxs("button",{className:"tab-btn "+("sent"===a?"active":""),onClick:()=>d("sent"),children:["Sent (",i.length,")"]})]}),p&&c.jsx("div",{className:"error-banner",children:p}),u?c.jsx("div",{className:"loading",children:"Loading requests..."}):"received"===a?c.jsx("div",{className:"requests-list",children:0===r.length?c.jsxs("div",{className:"empty-state",children:[c.jsx("p",{children:"No pending follow requests"}),c.jsx("small",{children:"When someone sends you a follow request, it will appear here"})]}):r.map(r=>c.jsxs("div",{className:"request-item received",children:[c.jsxs("div",{className:"requester-info",children:[c.jsx("span",{className:"status "+(r.onlineStatus?"online":"offline")}),c.jsxs("div",{className:"user-details",children:[c.jsx("span",{className:"username",children:r.username}),c.jsx("span",{className:"email",children:r.email})]})]}),c.jsxs("div",{className:"request-actions",children:[c.jsx("button",{className:"accept-btn",onClick:()=>(async r=>{try{await n.post(`${et}/api/users/${e}/accept-follow/${r}`,{},f()),s(e=>e.filter(e=>e._id!==r)),t?.(),alert("Follow request accepted")}catch(Yr){console.error("Error accepting request:",Yr),alert(Yr.response?.data?.message||"Failed to accept request")}})(r._id),title:"Accept follow request",children:"Accept"}),c.jsx("button",{className:"reject-btn",onClick:()=>(async t=>{try{await n.post(`${et}/api/users/${e}/reject-follow/${t}`,{},f()),s(e=>e.filter(e=>e._id!==t)),alert("Follow request rejected")}catch(Yr){console.error("Error rejecting request:",Yr),alert(Yr.response?.data?.message||"Failed to reject request")}})(r._id),title:"Reject follow request",children:"Reject"})]})]},r._id))}):c.jsx("div",{className:"requests-list",children:0===i.length?c.jsxs("div",{className:"empty-state",children:[c.jsx("p",{children:"No pending sent requests"}),c.jsx("small",{children:"Your follow requests will appear here until the recipient responds"})]}):i.map(r=>c.jsxs("div",{className:"request-item sent",children:[c.jsxs("div",{className:"requester-info",children:[c.jsx("span",{className:"status "+(r.onlineStatus?"online":"offline")}),c.jsxs("div",{className:"user-details",children:[c.jsx("span",{className:"username",children:r.username}),c.jsx("span",{className:"email",children:r.email})]})]}),c.jsx("div",{className:"request-actions",children:c.jsx("button",{className:"cancel-btn",onClick:()=>(async r=>{try{await n.post(`${et}/api/users/${r}/reject-follow/${e}`,{},f()),o(e=>e.filter(e=>e._id!==r)),t?.(),alert("Follow request cancelled")}catch(Yr){console.error("Error cancelling request:",Yr),alert(Yr.response?.data?.message||"Failed to cancel request")}})(r._id),title:"Cancel follow request",children:"Cancel"})})]},r._id))})]})}var rt=function(e,t){return(rt=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)};var nt,st,it,ot,at,ct,lt,dt,ut,ht,pt=function(){return pt=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var s in t=arguments[r])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e},pt.apply(this,arguments)};function mt(){if(ct)return at;ct=1;var e,t=function(){if(ot)return it;ot=1;var e=!("undefined"==typeof window||!window.document||!window.document.createElement),t={canUseDOM:e,canUseWorkers:"undefined"!=typeof Worker,canUseEventListeners:e&&!(!window.addEventListener&&!window.attachEvent),canUseViewport:e&&!!window.screen,isInWorker:!e};return it=t}();return t.canUseDOM&&(e=document.implementation&&document.implementation.hasFeature&&!0!==document.implementation.hasFeature("","")),at=function(r,n){if(!t.canUseDOM||n&&!("addEventListener"in document))return!1;var s="on"+r,i=s in document;if(!i){var o=document.createElement("div");o.setAttribute(s,"return;"),i="function"==typeof o[s]}return!i&&e&&"wheel"===r&&(i=document.implementation.hasFeature("Events.wheel","3.0")),i}}function ft(){if(dt)return lt;dt=1;var e=function(){if(st)return nt;st=1;var e,t,r,n,s,i,o,a,c,l,d,u,h,p,m,f=!1;function g(){if(!f){f=!0;var g=navigator.userAgent,y=/(?:MSIE.(\d+\.\d+))|(?:(?:Firefox|GranParadiso|Iceweasel).(\d+\.\d+))|(?:Opera(?:.+Version.|.)(\d+\.\d+))|(?:AppleWebKit.(\d+(?:\.\d+)?))|(?:Trident\/\d+\.\d+.*rv:(\d+\.\d+))/.exec(g),v=/(Mac OS X)|(Windows)|(Linux)/.exec(g);if(u=/\b(iPhone|iP[ao]d)/.exec(g),h=/\b(iP[ao]d)/.exec(g),l=/Android/i.exec(g),p=/FBAN\/\w+;/i.exec(g),m=/Mobile/i.exec(g),d=!!/Win64/.exec(g),y){(e=y[1]?parseFloat(y[1]):y[5]?parseFloat(y[5]):NaN)&&document&&document.documentMode&&(e=document.documentMode);var b=/(?:Trident\/(\d+.\d+))/.exec(g);i=b?parseFloat(b[1])+4:e,t=y[2]?parseFloat(y[2]):NaN,r=y[3]?parseFloat(y[3]):NaN,(n=y[4]?parseFloat(y[4]):NaN)?(y=/(?:Chrome\/(\d+\.\d+))/.exec(g),s=y&&y[1]?parseFloat(y[1]):NaN):s=NaN}else e=t=r=s=n=NaN;if(v){if(v[1]){var w=/(?:Mac OS X (\d+(?:[._]\d+)?))/.exec(g);o=!w||parseFloat(w[1].replace("_","."))}else o=!1;a=!!v[2],c=!!v[3]}else o=a=c=!1}}var y={ie:function(){return g()||e},ieCompatibilityMode:function(){return g()||i>e},ie64:function(){return y.ie()&&d},firefox:function(){return g()||t},opera:function(){return g()||r},webkit:function(){return g()||n},safari:function(){return y.webkit()},chrome:function(){return g()||s},windows:function(){return g()||a},osx:function(){return g()||o},linux:function(){return g()||c},iphone:function(){return g()||u},mobile:function(){return g()||u||h||l||m},nativeApp:function(){return g()||p},android:function(){return g()||l},ipad:function(){return g()||h}};return nt=y}(),t=mt();function r(e){var t=0,r=0,n=0,s=0;return"detail"in e&&(r=e.detail),"wheelDelta"in e&&(r=-e.wheelDelta/120),"wheelDeltaY"in e&&(r=-e.wheelDeltaY/120),"wheelDeltaX"in e&&(t=-e.wheelDeltaX/120),"axis"in e&&e.axis===e.HORIZONTAL_AXIS&&(t=r,r=0),n=10*t,s=10*r,"deltaY"in e&&(s=e.deltaY),"deltaX"in e&&(n=e.deltaX),(n||s)&&e.deltaMode&&(1==e.deltaMode?(n*=40,s*=40):(n*=800,s*=800)),n&&!t&&(t=n<1?-1:1),s&&!r&&(r=s<1?-1:1),{spinX:t,spinY:r,pixelX:n,pixelY:s}}return r.getEventType=function(){return e.firefox()?"DOMMouseScroll":t("wheel")?"wheel":"mousewheel"},lt=r}"function"==typeof SuppressedError&&SuppressedError;const gt=t(ht?ut:(ht=1,ut=ft()));function yt(e,t,r,n,s){void 0===s&&(s=0);var i=Ct(t.width,t.height,s),o=i.width,a=i.height;return{x:vt(e.x,o,r.width,n),y:vt(e.y,a,r.height,n)}}function vt(e,t,r,n){var s=t*n/2-r/2;return _t(e,-s,s)}function bt(e,t){return Math.sqrt(Math.pow(e.y-t.y,2)+Math.pow(e.x-t.x,2))}function wt(e,t){return 180*Math.atan2(t.y-e.y,t.x-e.x)/Math.PI}function xt(e,t){return Math.min(e,Math.max(0,t))}function St(e,t){return t}function jt(e,t){return{x:(t.x+e.x)/2,y:(t.y+e.y)/2}}function Ct(e,t,r){var n=r*Math.PI/180;return{width:Math.abs(Math.cos(n)*e)+Math.abs(Math.sin(n)*t),height:Math.abs(Math.sin(n)*e)+Math.abs(Math.cos(n)*t)}}function _t(e,t,r){return Math.min(Math.max(e,t),r)}function kt(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return e.filter(function(e){return"string"==typeof e&&e.length>0}).join(" ").trim()}var Nt=function(e){function t(){var r=null!==e&&e.apply(this,arguments)||this;return r.cropperRef=l.createRef(),r.imageRef=l.createRef(),r.videoRef=l.createRef(),r.containerPosition={x:0,y:0},r.containerRef=null,r.styleRef=null,r.containerRect=null,r.mediaSize={width:0,height:0,naturalWidth:0,naturalHeight:0},r.dragStartPosition={x:0,y:0},r.dragStartCrop={x:0,y:0},r.gestureZoomStart=0,r.gestureRotationStart=0,r.isTouching=!1,r.lastPinchDistance=0,r.lastPinchRotation=0,r.rafDragTimeout=null,r.rafPinchTimeout=null,r.wheelTimer=null,r.currentDoc="undefined"!=typeof document?document:null,r.currentWindow="undefined"!=typeof window?window:null,r.resizeObserver=null,r.previousCropSize=null,r.isInitialized=!1,r.state={cropSize:null,hasWheelJustStarted:!1,mediaObjectFit:void 0},r.initResizeObserver=function(){if(void 0!==window.ResizeObserver&&r.containerRef){var e=!0;r.resizeObserver=new window.ResizeObserver(function(t){e?e=!1:r.computeSizes()}),r.resizeObserver.observe(r.containerRef)}},r.preventZoomSafari=function(e){return e.preventDefault()},r.cleanEvents=function(){r.currentDoc&&(r.currentDoc.removeEventListener("mousemove",r.onMouseMove),r.currentDoc.removeEventListener("mouseup",r.onDragStopped),r.currentDoc.removeEventListener("touchmove",r.onTouchMove),r.currentDoc.removeEventListener("touchend",r.onDragStopped),r.currentDoc.removeEventListener("gesturechange",r.onGestureChange),r.currentDoc.removeEventListener("gestureend",r.onGestureEnd),r.currentDoc.removeEventListener("scroll",r.onScroll))},r.clearScrollEvent=function(){r.containerRef&&r.containerRef.removeEventListener("wheel",r.onWheel),r.wheelTimer&&clearTimeout(r.wheelTimer)},r.onMediaLoad=function(){var e=r.computeSizes();e&&(r.previousCropSize=e,r.emitCropData(),r.setInitialCrop(e),r.isInitialized=!0),r.props.onMediaLoaded&&r.props.onMediaLoaded(r.mediaSize)},r.setInitialCrop=function(e){if(r.props.initialCroppedAreaPercentages){var t=function(e,t,r,n,s,i){var o=Ct(t.width,t.height,r),a=_t(n.width/o.width*(100/e.width),s,i);return{crop:{x:a*o.width/2-n.width/2-o.width*a*(e.x/100),y:a*o.height/2-n.height/2-o.height*a*(e.y/100)},zoom:a}}(r.props.initialCroppedAreaPercentages,r.mediaSize,r.props.rotation,e,r.props.minZoom,r.props.maxZoom),n=t.crop,s=t.zoom;r.props.onCropChange(n),r.props.onZoomChange&&r.props.onZoomChange(s)}else if(r.props.initialCroppedAreaPixels){var i=function(e,t,r,n,s,i){void 0===r&&(r=0);var o=Ct(t.naturalWidth,t.naturalHeight,r),a=_t(function(e,t,r){var n=function(e){return e.width>e.height?e.width/e.naturalWidth:e.height/e.naturalHeight}(t);return r.height>r.width?r.height/(e.height*n):r.width/(e.width*n)}(e,t,n),s,i),c=n.height>n.width?n.height/e.height:n.width/e.width;return{crop:{x:((o.width-e.width)/2-e.x)*c,y:((o.height-e.height)/2-e.y)*c},zoom:a}}(r.props.initialCroppedAreaPixels,r.mediaSize,r.props.rotation,e,r.props.minZoom,r.props.maxZoom);n=i.crop,s=i.zoom;r.props.onCropChange(n),r.props.onZoomChange&&r.props.onZoomChange(s)}},r.computeSizes=function(){var e,t,n,s,i,o,a=r.imageRef.current||r.videoRef.current;if(a&&r.containerRef){r.containerRect=r.containerRef.getBoundingClientRect(),r.saveContainerPosition();var c=r.containerRect.width/r.containerRect.height,l=(null===(e=r.imageRef.current)||void 0===e?void 0:e.naturalWidth)||(null===(t=r.videoRef.current)||void 0===t?void 0:t.videoWidth)||0,d=(null===(n=r.imageRef.current)||void 0===n?void 0:n.naturalHeight)||(null===(s=r.videoRef.current)||void 0===s?void 0:s.videoHeight)||0,u=l/d,h=void 0;if(a.offsetWidth<l||a.offsetHeight<d)switch(r.state.mediaObjectFit){default:case"contain":h=c>u?{width:r.containerRect.height*u,height:r.containerRect.height}:{width:r.containerRect.width,height:r.containerRect.width/u};break;case"horizontal-cover":h={width:r.containerRect.width,height:r.containerRect.width/u};break;case"vertical-cover":h={width:r.containerRect.height*u,height:r.containerRect.height}}else h={width:a.offsetWidth,height:a.offsetHeight};r.mediaSize=pt(pt({},h),{naturalWidth:l,naturalHeight:d}),r.props.setMediaSize&&r.props.setMediaSize(r.mediaSize);var p=r.props.cropSize?r.props.cropSize:function(e,t,r,n,s,i){void 0===i&&(i=0);var o=Ct(e,t,i),a=o.width,c=o.height,l=Math.min(a,r),d=Math.min(c,n);return l>d*s?{width:d*s,height:d}:{width:l,height:l/s}}(r.mediaSize.width,r.mediaSize.height,r.containerRect.width,r.containerRect.height,r.props.aspect,r.props.rotation);return(null===(i=r.state.cropSize)||void 0===i?void 0:i.height)===p.height&&(null===(o=r.state.cropSize)||void 0===o?void 0:o.width)===p.width||r.props.onCropSizeChange&&r.props.onCropSizeChange(p),r.setState({cropSize:p},r.recomputeCropPosition),r.props.setCropSize&&r.props.setCropSize(p),p}},r.saveContainerPosition=function(){if(r.containerRef){var e=r.containerRef.getBoundingClientRect();r.containerPosition={x:e.left,y:e.top}}},r.onMouseDown=function(e){r.currentDoc&&(e.preventDefault(),r.currentDoc.addEventListener("mousemove",r.onMouseMove),r.currentDoc.addEventListener("mouseup",r.onDragStopped),r.saveContainerPosition(),r.onDragStart(t.getMousePoint(e)))},r.onMouseMove=function(e){return r.onDrag(t.getMousePoint(e))},r.onScroll=function(e){r.currentDoc&&(e.preventDefault(),r.saveContainerPosition())},r.onTouchStart=function(e){r.currentDoc&&(r.isTouching=!0,r.props.onTouchRequest&&!r.props.onTouchRequest(e)||(r.currentDoc.addEventListener("touchmove",r.onTouchMove,{passive:!1}),r.currentDoc.addEventListener("touchend",r.onDragStopped),r.saveContainerPosition(),2===e.touches.length?r.onPinchStart(e):1===e.touches.length&&r.onDragStart(t.getTouchPoint(e.touches[0]))))},r.onTouchMove=function(e){e.preventDefault(),2===e.touches.length?r.onPinchMove(e):1===e.touches.length&&r.onDrag(t.getTouchPoint(e.touches[0]))},r.onGestureStart=function(e){r.currentDoc&&(e.preventDefault(),r.currentDoc.addEventListener("gesturechange",r.onGestureChange),r.currentDoc.addEventListener("gestureend",r.onGestureEnd),r.gestureZoomStart=r.props.zoom,r.gestureRotationStart=r.props.rotation)},r.onGestureChange=function(e){if(e.preventDefault(),!r.isTouching){var n=t.getMousePoint(e),s=r.gestureZoomStart-1+e.scale;if(r.setNewZoom(s,n,{shouldUpdatePosition:!0}),r.props.onRotationChange){var i=r.gestureRotationStart+e.rotation;r.props.onRotationChange(i)}}},r.onGestureEnd=function(e){r.cleanEvents()},r.onDragStart=function(e){var t,n,s=e.x,i=e.y;r.dragStartPosition={x:s,y:i},r.dragStartCrop=pt({},r.props.crop),null===(n=(t=r.props).onInteractionStart)||void 0===n||n.call(t)},r.onDrag=function(e){var t=e.x,n=e.y;r.currentWindow&&(r.rafDragTimeout&&r.currentWindow.cancelAnimationFrame(r.rafDragTimeout),r.rafDragTimeout=r.currentWindow.requestAnimationFrame(function(){if(r.state.cropSize&&void 0!==t&&void 0!==n){var e=t-r.dragStartPosition.x,s=n-r.dragStartPosition.y,i={x:r.dragStartCrop.x+e,y:r.dragStartCrop.y+s},o=r.props.restrictPosition?yt(i,r.mediaSize,r.state.cropSize,r.props.zoom,r.props.rotation):i;r.props.onCropChange(o)}}))},r.onDragStopped=function(){var e,t;r.isTouching=!1,r.cleanEvents(),r.emitCropData(),null===(t=(e=r.props).onInteractionEnd)||void 0===t||t.call(e)},r.onWheel=function(e){if(r.currentWindow&&(!r.props.onWheelRequest||r.props.onWheelRequest(e))){e.preventDefault();var n=t.getMousePoint(e),s=gt(e).pixelY,i=r.props.zoom-s*r.props.zoomSpeed/200;r.setNewZoom(i,n,{shouldUpdatePosition:!0}),r.state.hasWheelJustStarted||r.setState({hasWheelJustStarted:!0},function(){var e,t;return null===(t=(e=r.props).onInteractionStart)||void 0===t?void 0:t.call(e)}),r.wheelTimer&&clearTimeout(r.wheelTimer),r.wheelTimer=r.currentWindow.setTimeout(function(){return r.setState({hasWheelJustStarted:!1},function(){var e,t;return null===(t=(e=r.props).onInteractionEnd)||void 0===t?void 0:t.call(e)})},250)}},r.getPointOnContainer=function(e,t){var n=e.x,s=e.y;if(!r.containerRect)throw new Error("The Cropper is not mounted");return{x:r.containerRect.width/2-(n-t.x),y:r.containerRect.height/2-(s-t.y)}},r.getPointOnMedia=function(e){var t=e.x,n=e.y,s=r.props,i=s.crop,o=s.zoom;return{x:(t+i.x)/o,y:(n+i.y)/o}},r.setNewZoom=function(e,t,n){var s=(void 0===n?{}:n).shouldUpdatePosition,i=void 0===s||s;if(r.state.cropSize&&r.props.onZoomChange){var o=_t(e,r.props.minZoom,r.props.maxZoom);if(i){var a=r.getPointOnContainer(t,r.containerPosition),c=r.getPointOnMedia(a),l={x:c.x*o-a.x,y:c.y*o-a.y},d=r.props.restrictPosition?yt(l,r.mediaSize,r.state.cropSize,o,r.props.rotation):l;r.props.onCropChange(d)}r.props.onZoomChange(o)}},r.getCropData=function(){return r.state.cropSize?function(e,t,r,n,s,i,o){void 0===i&&(i=0),void 0===o&&(o=!0);var a=o?xt:St,c=Ct(t.width,t.height,i),l=Ct(t.naturalWidth,t.naturalHeight,i),d={x:a(100,((c.width-r.width/s)/2-e.x/s)/c.width*100),y:a(100,((c.height-r.height/s)/2-e.y/s)/c.height*100),width:a(100,r.width/c.width*100/s),height:a(100,r.height/c.height*100/s)},u=Math.round(a(l.width,d.width*l.width/100)),h=Math.round(a(l.height,d.height*l.height/100)),p=l.width>=l.height*n?{width:Math.round(h*n),height:h}:{width:u,height:Math.round(u/n)};return{croppedAreaPercentages:d,croppedAreaPixels:pt(pt({},p),{x:Math.round(a(l.width-p.width,d.x*l.width/100)),y:Math.round(a(l.height-p.height,d.y*l.height/100))})}}(r.props.restrictPosition?yt(r.props.crop,r.mediaSize,r.state.cropSize,r.props.zoom,r.props.rotation):r.props.crop,r.mediaSize,r.state.cropSize,r.getAspect(),r.props.zoom,r.props.rotation,r.props.restrictPosition):null},r.emitCropData=function(){var e=r.getCropData();if(e){var t=e.croppedAreaPercentages,n=e.croppedAreaPixels;r.props.onCropComplete&&r.props.onCropComplete(t,n),r.props.onCropAreaChange&&r.props.onCropAreaChange(t,n)}},r.emitCropAreaChange=function(){var e=r.getCropData();if(e){var t=e.croppedAreaPercentages,n=e.croppedAreaPixels;r.props.onCropAreaChange&&r.props.onCropAreaChange(t,n)}},r.recomputeCropPosition=function(){var e,t;if(r.state.cropSize){var n=r.props.crop;if(r.isInitialized&&(null===(e=r.previousCropSize)||void 0===e?void 0:e.width)&&(null===(t=r.previousCropSize)||void 0===t?void 0:t.height))if(Math.abs(r.previousCropSize.width-r.state.cropSize.width)>1e-6||Math.abs(r.previousCropSize.height-r.state.cropSize.height)>1e-6){var s=r.state.cropSize.width/r.previousCropSize.width,i=r.state.cropSize.height/r.previousCropSize.height;n={x:r.props.crop.x*s,y:r.props.crop.y*i}}var o=r.props.restrictPosition?yt(n,r.mediaSize,r.state.cropSize,r.props.zoom,r.props.rotation):n;r.previousCropSize=r.state.cropSize,r.props.onCropChange(o),r.emitCropData()}},r.onKeyDown=function(e){var t,n,s=r.props,i=s.crop,o=s.onCropChange,a=s.keyboardStep,c=s.zoom,l=s.rotation,d=a;if(r.state.cropSize){e.shiftKey&&(d*=.2);var u=pt({},i);switch(e.key){case"ArrowUp":u.y-=d,e.preventDefault();break;case"ArrowDown":u.y+=d,e.preventDefault();break;case"ArrowLeft":u.x-=d,e.preventDefault();break;case"ArrowRight":u.x+=d,e.preventDefault();break;default:return}r.props.restrictPosition&&(u=yt(u,r.mediaSize,r.state.cropSize,c,l)),e.repeat||null===(n=(t=r.props).onInteractionStart)||void 0===n||n.call(t),o(u)}},r.onKeyUp=function(e){var t,n;switch(e.key){case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":e.preventDefault();break;default:return}r.emitCropData(),null===(n=(t=r.props).onInteractionEnd)||void 0===n||n.call(t)},r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}rt(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}(t,e),t.prototype.componentDidMount=function(){this.currentDoc&&this.currentWindow&&(this.containerRef&&(this.containerRef.ownerDocument&&(this.currentDoc=this.containerRef.ownerDocument),this.currentDoc.defaultView&&(this.currentWindow=this.currentDoc.defaultView),this.initResizeObserver(),void 0===window.ResizeObserver&&this.currentWindow.addEventListener("resize",this.computeSizes),this.props.zoomWithScroll&&this.containerRef.addEventListener("wheel",this.onWheel,{passive:!1}),this.containerRef.addEventListener("gesturestart",this.onGestureStart)),this.currentDoc.addEventListener("scroll",this.onScroll),this.props.disableAutomaticStylesInjection||(this.styleRef=this.currentDoc.createElement("style"),this.styleRef.setAttribute("type","text/css"),this.props.nonce&&this.styleRef.setAttribute("nonce",this.props.nonce),this.styleRef.innerHTML=".reactEasyCrop_Container {\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  overflow: hidden;\n  user-select: none;\n  touch-action: none;\n  cursor: move;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}\n\n.reactEasyCrop_Image,\n.reactEasyCrop_Video {\n  will-change: transform; /* this improves performances and prevent painting issues on iOS Chrome */\n}\n\n.reactEasyCrop_Contain {\n  max-width: 100%;\n  max-height: 100%;\n  margin: auto;\n  position: absolute;\n  top: 0;\n  bottom: 0;\n  left: 0;\n  right: 0;\n}\n.reactEasyCrop_Cover_Horizontal {\n  width: 100%;\n  height: auto;\n}\n.reactEasyCrop_Cover_Vertical {\n  width: auto;\n  height: 100%;\n}\n\n.reactEasyCrop_CropArea {\n  position: absolute;\n  left: 50%;\n  top: 50%;\n  transform: translate(-50%, -50%);\n  border: 1px solid rgba(255, 255, 255, 0.5);\n  box-sizing: border-box;\n  box-shadow: 0 0 0 9999em;\n  color: rgba(0, 0, 0, 0.5);\n  overflow: hidden;\n}\n\n.reactEasyCrop_CropAreaRound {\n  border-radius: 50%;\n}\n\n.reactEasyCrop_CropAreaGrid::before {\n  content: ' ';\n  box-sizing: border-box;\n  position: absolute;\n  border: 1px solid rgba(255, 255, 255, 0.5);\n  top: 0;\n  bottom: 0;\n  left: 33.33%;\n  right: 33.33%;\n  border-top: 0;\n  border-bottom: 0;\n}\n\n.reactEasyCrop_CropAreaGrid::after {\n  content: ' ';\n  box-sizing: border-box;\n  position: absolute;\n  border: 1px solid rgba(255, 255, 255, 0.5);\n  top: 33.33%;\n  bottom: 33.33%;\n  left: 0;\n  right: 0;\n  border-left: 0;\n  border-right: 0;\n}\n",this.currentDoc.head.appendChild(this.styleRef)),this.imageRef.current&&this.imageRef.current.complete&&this.onMediaLoad(),this.props.setImageRef&&this.props.setImageRef(this.imageRef),this.props.setVideoRef&&this.props.setVideoRef(this.videoRef),this.props.setCropperRef&&this.props.setCropperRef(this.cropperRef))},t.prototype.componentWillUnmount=function(){var e,t;this.currentDoc&&this.currentWindow&&(void 0===window.ResizeObserver&&this.currentWindow.removeEventListener("resize",this.computeSizes),null===(e=this.resizeObserver)||void 0===e||e.disconnect(),this.containerRef&&this.containerRef.removeEventListener("gesturestart",this.preventZoomSafari),this.styleRef&&(null===(t=this.styleRef.parentNode)||void 0===t||t.removeChild(this.styleRef)),this.cleanEvents(),this.props.zoomWithScroll&&this.clearScrollEvent())},t.prototype.componentDidUpdate=function(e){var t,r,n,s,i,o,a,c,l;e.rotation!==this.props.rotation?(this.computeSizes(),this.recomputeCropPosition()):e.aspect!==this.props.aspect||e.objectFit!==this.props.objectFit?this.computeSizes():e.zoom!==this.props.zoom?this.recomputeCropPosition():(null===(t=e.cropSize)||void 0===t?void 0:t.height)!==(null===(r=this.props.cropSize)||void 0===r?void 0:r.height)||(null===(n=e.cropSize)||void 0===n?void 0:n.width)!==(null===(s=this.props.cropSize)||void 0===s?void 0:s.width)?this.computeSizes():(null===(i=e.crop)||void 0===i?void 0:i.x)===(null===(o=this.props.crop)||void 0===o?void 0:o.x)&&(null===(a=e.crop)||void 0===a?void 0:a.y)===(null===(c=this.props.crop)||void 0===c?void 0:c.y)||this.emitCropAreaChange(),e.zoomWithScroll!==this.props.zoomWithScroll&&this.containerRef&&(this.props.zoomWithScroll?this.containerRef.addEventListener("wheel",this.onWheel,{passive:!1}):this.clearScrollEvent()),e.video!==this.props.video&&(null===(l=this.videoRef.current)||void 0===l||l.load());var d=this.getObjectFit();d!==this.state.mediaObjectFit&&this.setState({mediaObjectFit:d},this.computeSizes)},t.prototype.getAspect=function(){var e=this.props,t=e.cropSize,r=e.aspect;return t?t.width/t.height:r},t.prototype.getObjectFit=function(){var e,t,r,n;if("cover"===this.props.objectFit){if((this.imageRef.current||this.videoRef.current)&&this.containerRef){this.containerRect=this.containerRef.getBoundingClientRect();var s=this.containerRect.width/this.containerRect.height;return((null===(e=this.imageRef.current)||void 0===e?void 0:e.naturalWidth)||(null===(t=this.videoRef.current)||void 0===t?void 0:t.videoWidth)||0)/((null===(r=this.imageRef.current)||void 0===r?void 0:r.naturalHeight)||(null===(n=this.videoRef.current)||void 0===n?void 0:n.videoHeight)||0)<s?"horizontal-cover":"vertical-cover"}return"horizontal-cover"}return this.props.objectFit},t.prototype.onPinchStart=function(e){var r=t.getTouchPoint(e.touches[0]),n=t.getTouchPoint(e.touches[1]);this.lastPinchDistance=bt(r,n),this.lastPinchRotation=wt(r,n),this.onDragStart(jt(r,n))},t.prototype.onPinchMove=function(e){var r=this;if(this.currentDoc&&this.currentWindow){var n=t.getTouchPoint(e.touches[0]),s=t.getTouchPoint(e.touches[1]),i=jt(n,s);this.onDrag(i),this.rafPinchTimeout&&this.currentWindow.cancelAnimationFrame(this.rafPinchTimeout),this.rafPinchTimeout=this.currentWindow.requestAnimationFrame(function(){var e=bt(n,s),t=r.props.zoom*(e/r.lastPinchDistance);r.setNewZoom(t,i,{shouldUpdatePosition:!1}),r.lastPinchDistance=e;var o=wt(n,s),a=r.props.rotation+(o-r.lastPinchRotation);r.props.onRotationChange&&r.props.onRotationChange(a),r.lastPinchRotation=o})}},t.prototype.render=function(){var e,t=this,r=this.props,n=r.image,s=r.video,i=r.mediaProps,o=r.cropperProps,a=r.transform,c=r.crop,d=c.x,u=c.y,h=r.rotation,p=r.zoom,m=r.cropShape,f=r.showGrid,g=r.roundCropAreaPixels,y=r.style,v=y.containerStyle,b=y.cropAreaStyle,w=y.mediaStyle,x=r.classes,S=x.containerClassName,j=x.cropAreaClassName,C=x.mediaClassName,_=null!==(e=this.state.mediaObjectFit)&&void 0!==e?e:this.getObjectFit();return l.createElement("div",{onMouseDown:this.onMouseDown,onTouchStart:this.onTouchStart,ref:function(e){return t.containerRef=e},"data-testid":"container",style:v,className:kt("reactEasyCrop_Container",S)},n?l.createElement("img",pt({alt:"",className:kt("reactEasyCrop_Image","contain"===_&&"reactEasyCrop_Contain","horizontal-cover"===_&&"reactEasyCrop_Cover_Horizontal","vertical-cover"===_&&"reactEasyCrop_Cover_Vertical",C)},i,{src:n,ref:this.imageRef,style:pt(pt({},w),{transform:a||"translate(".concat(d,"px, ").concat(u,"px) rotate(").concat(h,"deg) scale(").concat(p,")")}),onLoad:this.onMediaLoad})):s&&l.createElement("video",pt({autoPlay:!0,playsInline:!0,loop:!0,muted:!0,className:kt("reactEasyCrop_Video","contain"===_&&"reactEasyCrop_Contain","horizontal-cover"===_&&"reactEasyCrop_Cover_Horizontal","vertical-cover"===_&&"reactEasyCrop_Cover_Vertical",C)},i,{ref:this.videoRef,onLoadedMetadata:this.onMediaLoad,style:pt(pt({},w),{transform:a||"translate(".concat(d,"px, ").concat(u,"px) rotate(").concat(h,"deg) scale(").concat(p,")")}),controls:!1}),(Array.isArray(s)?s:[{src:s}]).map(function(e){return l.createElement("source",pt({key:e.src},e))})),this.state.cropSize&&l.createElement("div",pt({ref:this.cropperRef,style:pt(pt({},b),{width:g?Math.round(this.state.cropSize.width):this.state.cropSize.width,height:g?Math.round(this.state.cropSize.height):this.state.cropSize.height}),tabIndex:0,onKeyDown:this.onKeyDown,onKeyUp:this.onKeyUp,"data-testid":"cropper",className:kt("reactEasyCrop_CropArea","round"===m&&"reactEasyCrop_CropAreaRound",f&&"reactEasyCrop_CropAreaGrid",j)},o)))},t.defaultProps={zoom:1,rotation:0,aspect:4/3,maxZoom:3,minZoom:1,cropShape:"rect",objectFit:"contain",showGrid:!0,style:{},classes:{},mediaProps:{},cropperProps:{},zoomSpeed:1,restrictPosition:!0,zoomWithScroll:!0,keyboardStep:1},t.getMousePoint=function(e){return{x:Number(e.clientX),y:Number(e.clientY)}},t.getTouchPoint=function(e){return{x:Number(e.clientX),y:Number(e.clientY)}},t}(l.Component);function Et(e){return e*Math.PI/180}async function Rt(e,t,r=0,n={horizontal:!1,vertical:!1}){const s=await(i=e,new Promise((e,t)=>{const r=new Image;r.addEventListener("load",()=>e(r)),r.addEventListener("error",e=>t(e)),r.setAttribute("crossOrigin","anonymous"),r.src=i}));var i;const o=document.createElement("canvas"),a=o.getContext("2d");if(!a)return null;const c=Et(r),{width:l,height:d}=function(e,t,r){const n=Et(r);return{width:Math.abs(Math.cos(n)*e)+Math.abs(Math.sin(n)*t),height:Math.abs(Math.sin(n)*e)+Math.abs(Math.cos(n)*t)}}(s.width,s.height,r);o.width=l,o.height=d,a.translate(l/2,d/2),a.rotate(c),a.scale(n.horizontal?-1:1,n.vertical?-1:1),a.translate(-s.width/2,-s.height/2),a.drawImage(s,0,0);const u=a.getImageData(t.x,t.y,t.width,t.height);return o.width=t.width,o.height=t.height,a.putImageData(u,0,0),o.toDataURL("image/jpeg")}const Tt=({imageSrc:e,onCropComplete:t,onCancel:r})=>{const[n,s]=l.useState({x:0,y:0}),[i,o]=l.useState(1),[a,d]=l.useState(null),u=l.useCallback((e,t)=>{d(t)},[]),h=l.useCallback(async()=>{try{const r=await Rt(e,a);t(r)}catch(r){console.error(r)}},[e,a,t]);return c.jsx("div",{className:"modal-overlay",onClick:e=>e.stopPropagation(),children:c.jsxs("div",{className:"modal",style:{width:"90%",maxWidth:"500px",height:"80vh",display:"flex",flexDirection:"column"},children:[c.jsxs("div",{className:"modal-header",children:[c.jsx("h3",{children:"Adjust Photo"}),c.jsx("button",{className:"icon-btn",onClick:r,children:""})]}),c.jsxs("div",{className:"modal-body",style:{flex:1,position:"relative",overflow:"hidden",padding:0},children:[c.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:"60px",background:"#333"},children:c.jsx(Nt,{image:e,crop:n,zoom:i,aspect:1,onCropChange:e=>{s(e)},onCropComplete:u,onZoomChange:e=>{o(e)},showGrid:!1,cropShape:"round"})}),c.jsxs("div",{style:{position:"absolute",bottom:0,left:0,right:0,height:"60px",display:"flex",alignItems:"center",justifyContent:"center",background:"var(--bg-color)",padding:"0 20px",borderTop:"1px solid var(--sidebar-border)"},children:[c.jsx("span",{style:{marginRight:"10px",fontSize:"0.9rem"},children:"Zoom:"}),c.jsx("input",{type:"range",value:i,min:1,max:3,step:.1,"aria-labelledby":"Zoom",onChange:e=>o(e.target.value),className:"zoom-range",style:{flex:1}})]})]}),c.jsxs("div",{className:"modal-footer",style:{padding:"1rem",borderTop:"1px solid var(--sidebar-border)",display:"flex",justifyContent:"flex-end",gap:"1rem"},children:[c.jsx("button",{className:"text-btn",onClick:r,children:"Cancel"}),c.jsx("button",{className:"primary-btn",onClick:h,children:"Save Photo"})]})]})})},At="https://real-time-chatapp-o0me.onrender.com".replace(/\/$/,"");function It({user:e,onClose:t,onUpdate:r}){const[s,i]=l.useState({username:e.username||"",bio:e.bio||"",avatarUrl:e.avatarUrl||"",phoneNumber:e.phoneNumber||""}),[o,a]=l.useState(!1),[d,u]=l.useState(""),[h,p]=l.useState(!1),[m,f]=l.useState(null),g=l.useRef(null);function y(e){const{name:t,value:r}=e.target;i(e=>({...e,[t]:r}))}return c.jsx("div",{className:"modal-overlay",onClick:t,children:h&&m?c.jsx(Tt,{imageSrc:m,onCropComplete:function(e){i(t=>({...t,avatarUrl:e})),p(!1),f(null)},onCancel:()=>{p(!1),f(null)}}):c.jsxs("div",{className:"modal profile-edit-modal",onClick:e=>e.stopPropagation(),children:[c.jsxs("div",{className:"modal-header",children:[c.jsx("h3",{children:"Edit Profile"}),c.jsx("button",{className:"icon-btn profile-modal-close",onClick:t,"aria-label":"Close edit profile modal",children:c.jsx("svg",{viewBox:"0 0 24 24",role:"presentation","aria-hidden":"true",children:c.jsx("path",{d:"M6 6l12 12M18 6L6 18"})})})]}),c.jsxs("div",{className:"modal-body profile-edit-modal-body",children:[d&&c.jsx("div",{className:"error-banner",children:d}),c.jsxs("form",{onSubmit:async function(i){i.preventDefault(),a(!0),u("");try{const i=await n.put(`${At}/api/users/${e._id}/update`,s);r(i.data.user),t()}catch(Yr){u(Yr.response?.data?.message||"Failed to update profile")}finally{a(!1)}},className:"profile-edit-form",children:[c.jsxs("div",{className:"profile-edit-avatar-block",children:[c.jsxs("button",{type:"button",className:"profile-edit-avatar",onClick:()=>g.current?.click(),style:s.avatarUrl?{backgroundImage:`url(${s.avatarUrl})`}:void 0,"aria-label":"Change profile photo",children:[!s.avatarUrl&&c.jsx("span",{className:"profile-edit-avatar-fallback",children:s.username?.charAt(0).toUpperCase()||"U"}),c.jsx("span",{className:"profile-edit-avatar-badge","aria-hidden":"true",children:c.jsxs("svg",{viewBox:"0 0 24 24",role:"presentation",children:[c.jsx("path",{d:"M4.5 7.5h3l1.1-1.8h6.8l1.1 1.8h3A1.5 1.5 0 0 1 21 9v8a1.5 1.5 0 0 1-1.5 1.5h-15A1.5 1.5 0 0 1 3 17V9a1.5 1.5 0 0 1 1.5-1.5z"}),c.jsx("circle",{cx:"12",cy:"13",r:"3.2"})]})})]}),c.jsx("input",{type:"file",ref:g,onChange:function(e){const t=e.target.files[0];if(t){const e=new FileReader;e.onloadend=()=>{f(e.result),p(!0)},e.readAsDataURL(t)}e.target.value=null},className:"profile-edit-file-input",accept:"image/*"}),c.jsxs("div",{className:"profile-edit-avatar-actions",children:[c.jsx("button",{type:"button",className:"profile-avatar-action",onClick:()=>g.current?.click(),children:"Change Photo"}),s.avatarUrl&&c.jsx("button",{type:"button",className:"profile-avatar-action profile-avatar-remove",onClick:function(){i(e=>({...e,avatarUrl:""}))},children:"Remove"})]})]}),c.jsxs("div",{className:"form-group profile-edit-field",children:[c.jsx("label",{htmlFor:"edit-username",children:"Username"}),c.jsx("input",{id:"edit-username",name:"username",value:s.username,onChange:y,className:"text-input",required:!0})]}),c.jsxs("div",{className:"form-group profile-edit-field",children:[c.jsx("label",{htmlFor:"edit-phone-number",children:"Phone Number"}),c.jsx("input",{id:"edit-phone-number",name:"phoneNumber",value:s.phoneNumber,onChange:y,className:"text-input",placeholder:"+1 234 567 8900"})]}),c.jsxs("div",{className:"form-group profile-edit-field",children:[c.jsx("label",{htmlFor:"edit-bio",children:"Bio"}),c.jsx("input",{id:"edit-bio",name:"bio",value:s.bio,onChange:y,className:"text-input",placeholder:"Tell us about yourself"})]}),c.jsx("button",{type:"submit",className:"primary-btn profile-edit-submit",disabled:o,children:o?"Saving...":"Save Changes"})]})]})]})})}function Pt({user:e,onClose:t}){if(!e)return null;const r=Boolean(e.onlineStatus);return c.jsx("div",{className:"modal-overlay",onClick:t,children:c.jsxs("div",{className:"modal profile-view-modal",onClick:e=>e.stopPropagation(),children:[c.jsxs("div",{className:"modal-header",children:[c.jsxs("h3",{children:[c.jsx("span",{className:"profile-view-title-icon","aria-hidden":"true",children:c.jsxs("svg",{viewBox:"0 0 24 24",role:"presentation",children:[c.jsx("path",{d:"M12 12a4.2 4.2 0 1 0 0-8.4 4.2 4.2 0 0 0 0 8.4z"}),c.jsx("path",{d:"M4.5 20.2a7.5 7.5 0 0 1 15 0"})]})}),"User Profile"]}),c.jsx("button",{className:"icon-btn profile-modal-close",onClick:t,"aria-label":"Close profile",children:c.jsx("svg",{viewBox:"0 0 24 24",role:"presentation","aria-hidden":"true",children:c.jsx("path",{d:"M6 6l12 12M18 6L6 18"})})})]}),c.jsxs("div",{className:"modal-body profile-view-modal-body",children:[c.jsxs("div",{className:"profile-view-identity",children:[c.jsx("div",{className:"profile-view-avatar",style:e.avatarUrl?{backgroundImage:`url(${e.avatarUrl})`}:void 0,"aria-label":`${e.username||"User"} profile avatar`,children:!e.avatarUrl&&c.jsx("span",{className:"profile-view-avatar-fallback",children:e.username?.charAt(0).toUpperCase()||"U"})}),c.jsx("h2",{className:"profile-view-name",children:e.username||"Unknown User"}),c.jsx("p",{className:"profile-view-status "+(r?"online":"offline"),children:r?"Online":"Offline"})]}),c.jsxs("div",{className:"profile-view-fields",children:[c.jsxs("div",{className:"profile-view-field",children:[c.jsx("span",{className:"profile-view-field-label",children:"Bio"}),c.jsx("p",{className:"profile-view-field-value",children:e.bio||"No bio added yet"})]}),c.jsxs("div",{className:"profile-view-field",children:[c.jsx("span",{className:"profile-view-field-label",children:"Phone Number"}),c.jsx("p",{className:"profile-view-field-value",children:e.phoneNumber||"Not provided"})]}),c.jsxs("div",{className:"profile-view-field",children:[c.jsx("span",{className:"profile-view-field-label",children:"Email"}),c.jsx("p",{className:"profile-view-field-value",children:e.email||"Not provided"})]})]}),c.jsx("button",{className:"primary-btn profile-view-close",onClick:t,children:"Close"})]})]})})}const Mt="chat_recent_emojis_v1",Ot="chat_emoji_skin_tone_v1",Ut=["","","","","",""],Dt=["frequent","people","nature","foods","places","activity","objects","symbols","flags"];function Lt(){try{const e=JSON.parse(localStorage.getItem(Mt)||"[]");return Array.isArray(e)?e.filter(e=>"string"==typeof e&&e.length>0):[]}catch{return[]}}function Bt(){const e=Number(localStorage.getItem(Ot));return Number.isInteger(e)&&e>=1&&e<=6?e:1}function zt(e,t){return Boolean(e?.current&&t instanceof Node&&e.current.contains(t))}function $t({isOpen:e,theme:t,anchorRef:r,onClose:n,onEmojiSelect:s}){const i=l.useRef(null),[o,a]=l.useState(null),[d,u]=l.useState(null),[h,p]=l.useState(Lt),[m,g]=l.useState(Bt),[y,v]=l.useState("emoji");l.useEffect(()=>{if(!e||o&&d)return;let t=!1;return(async()=>{const[{default:e},r]=await Promise.all([f(()=>import("./module-_-3Zp_Bt.js"),__vite__mapDeps([0,1,2]),import.meta.url),f(()=>import("./native-j0VGWyyJ.js"),[],import.meta.url)]);t||(a(()=>e),u(r.default||r))})().catch(e=>{console.error("Failed to load emoji picker:",e)}),()=>{t=!0}},[d,e,o]),l.useEffect(()=>{if(!e)return;const t=e=>{zt(i,e.target)||zt(r,e.target)||n()},s=e=>{"Escape"===e.key&&n()};return document.addEventListener("pointerdown",t,!0),document.addEventListener("keydown",s),()=>{document.removeEventListener("pointerdown",t,!0),document.removeEventListener("keydown",s)}},[r,e,n]);const b=l.useCallback(e=>{p(t=>{const r=[e,...t.filter(t=>t!==e)].slice(0,24);var n;return n=r,localStorage.setItem(Mt,JSON.stringify(n)),r})},[]),w=l.useCallback(e=>{const t=function(e){return e?.native?e.native:e?.skins?.length>0?e.skins[0].native:""}(e);t&&(b(t),s(t))},[b,s]),x=l.useCallback(e=>{b(e),s(e)},[b,s]),S=l.useCallback(e=>{var t;g(e),t=e,localStorage.setItem(Ot,String(t))},[]),j=l.useCallback(()=>{S(m>=6?1:m+1)},[S,m]),C=l.useMemo(()=>h.slice(0,12),[h]);return e?c.jsxs("section",{className:"wa-emoji-sheet",ref:i,role:"dialog","aria-modal":"false","aria-label":"Emoji picker panel",children:[c.jsxs("header",{className:"wa-emoji-recent-header",children:[c.jsx("span",{children:"Recent"}),c.jsxs("div",{className:"wa-emoji-recent-list",role:"list",children:[0===C.length&&c.jsx("span",{className:"wa-emoji-recent-empty",children:"No recent emojis"}),C.map(e=>c.jsx("button",{type:"button",className:"wa-emoji-recent-btn",onClick:()=>x(e),"aria-label":`Insert recent emoji ${e}`,children:e},`recent-${e}`))]}),c.jsx("button",{type:"button",className:"wa-emoji-skin-btn",onClick:j,"aria-label":`Change skin tone, current tone ${m}`,title:"Change skin tone",children:Ut[m-1]})]}),c.jsx("div",{className:"wa-emoji-body",children:"emoji"===y?o&&d?c.jsx(o,{data:d,onEmojiSelect:w,theme:"light"===t?"light":"dark",autoFocus:!0,dynamicWidth:!0,searchPosition:"sticky",navPosition:"top",previewPosition:"none",skin:m,skinTonePosition:"none",onSkinToneChange:S,categories:Dt,maxFrequentRows:2,set:"native"}):c.jsx("div",{className:"wa-emoji-loading",children:"Loading emojis..."}):c.jsx("div",{className:"wa-emoji-loading",children:"gif"===y?"GIF picker coming soon":"Sticker picker coming soon"})}),c.jsxs("footer",{className:"wa-emoji-footer",children:[c.jsx("button",{type:"button",className:"wa-emoji-footer-btn "+("emoji"===y?"active":""),onClick:()=>v("emoji"),"aria-label":"Emoji tab",children:""}),c.jsx("button",{type:"button",className:"wa-emoji-footer-btn "+("gif"===y?"active":""),onClick:()=>v("gif"),"aria-label":"GIF tab",children:"GIF"}),c.jsx("button",{type:"button",className:"wa-emoji-footer-btn "+("sticker"===y?"active":""),onClick:()=>v("sticker"),"aria-label":"Sticker tab",children:""})]})]}):null}const Ft=["","","","","",""];const qt=l.memo(function({visible:e,activeEmoji:t,onSelect:r}){return e?c.jsx("div",{className:"wa-reaction-bar",role:"toolbar","aria-label":"React to message",children:Ft.map(e=>c.jsx("button",{type:"button",className:"wa-reaction-option "+(t===e?"active":""),onMouseDown:e=>{e.preventDefault()},onClick:()=>r(e),"aria-label":`React with ${e}`,title:`React with ${e}`,children:e},e))}):null});function Wt(e){return e?"string"==typeof e?e:e._id||"":""}function Kt(e){const t=String(e||"").trim();if(!t)return null;try{const e=JSON.parse(t);return e&&"chat_attachment"===e.kind&&"string"==typeof e.dataUrl?{name:String(e.name||"attachment"),mimeType:String(e.mimeType||""),size:Number(e.size)||0,dataUrl:e.dataUrl}:null}catch{return null}}const Vt=l.memo(function({message:e,currentUserId:t,onReact:r,onOpenSenderProfile:n,onReply:s,onDelete:i}){const[o,a]=l.useState(!1),d=l.useRef(null),u=l.useRef(null),h=Wt(e.senderUserId),p=h===t||""===h,m=e.senderUserId?.username||"Unknown",f=e.replyTo&&"object"==typeof e.replyTo?e.replyTo:null,g=Wt(f?.senderUserId)===t?"You":f?.senderUserId?.username||"Unknown",y=l.useMemo(()=>"image"!==e.messageType&&"file"!==e.messageType?null:Kt(e.messageContent),[e.messageContent,e.messageType]),v=Boolean(y?.mimeType?.startsWith("image/")),b=l.useMemo(()=>function(e){if(!Number.isFinite(e)||e<=0)return"";const t=["B","KB","MB","GB"];let r=e,n=0;for(;r>=1024&&n<t.length-1;)r/=1024,n+=1;const s=r>=10||0===n?0:1;return`${r.toFixed(s)} ${t[n]}`}(y?.size||0),[y?.size]),w=l.useMemo(()=>{const e=Kt(f?.messageContent);if(e){return`${e.mimeType?.startsWith("image/")?"Image":"File"}: ${e.name}`}return function(e,t=120){const r=String(e||"").trim();return r?r.length<=t?r:`${r.slice(0,t-3)}...`:"Message unavailable"}(f?.messageContent,90)},[f?.messageContent]),x=l.useMemo(()=>(e.reactions||[]).find(e=>Wt(e.user)===t)?.emoji||null,[t,e.reactions]),S=l.useMemo(()=>function(e,t){const r=new Map;return e.forEach(e=>{const n=e.emoji,s=r.get(n)||{emoji:n,count:0,reactedByMe:!1};s.count+=1,Wt(e.user)===t&&(s.reactedByMe=!0),r.set(n,s)}),Array.from(r.values())}(e.reactions||[],t),[t,e.reactions]),j=l.useCallback(t=>{r(e._id,t),a(!1)},[e._id,r]),C=l.useCallback(()=>{d.current&&(clearTimeout(d.current),d.current=null)},[]);l.useEffect(()=>()=>{C()},[C]),l.useEffect(()=>{if(!o)return;const e=e=>{u.current?.contains(e.target)||a(!1)},t=e=>{"Escape"===e.key&&a(!1)};return document.addEventListener("pointerdown",e),document.addEventListener("contextmenu",e),document.addEventListener("keydown",t),()=>{document.removeEventListener("pointerdown",e),document.removeEventListener("contextmenu",e),document.removeEventListener("keydown",t)}},[o]);const _=l.useCallback(()=>{C(),d.current=window.setTimeout(()=>{a(!0)},420)},[C]),k=l.useCallback(()=>{C()},[C]);return c.jsxs("article",{ref:u,className:"message wa-message "+(p?"sent":"received"),onContextMenu:e=>{e.preventDefault(),a(!0)},onTouchStart:_,onTouchEnd:k,onTouchMove:C,onTouchCancel:C,onKeyDown:e=>{"Escape"===e.key&&a(!1),("ContextMenu"===e.key||e.shiftKey&&"F10"===e.key)&&(e.preventDefault(),a(!0))},tabIndex:0,role:"group","aria-label":`Message from ${p?"you":m}`,children:[!p&&c.jsx("button",{type:"button",className:"msg-sender msg-sender-button",onClick:()=>n?.(e.senderUserId),"aria-label":`Open ${m} profile`,children:m}),c.jsxs("div",{className:"msg-bubble",children:[c.jsx("div",{className:"glass-reflex","aria-hidden":"true"}),f&&c.jsxs("div",{className:"msg-reply-quote","aria-label":`Reply to ${g}`,children:[c.jsx("span",{className:"msg-reply-sender",children:g}),c.jsx("span",{className:"msg-reply-text",children:w})]}),y?c.jsxs("div",{className:"msg-attachment "+(v?"image":"file"),children:[v&&c.jsx("a",{className:"msg-attachment-image-link",href:y.dataUrl,download:y.name,"aria-label":`Open ${y.name}`,children:c.jsx("img",{src:y.dataUrl,alt:y.name,className:"msg-attachment-image",loading:"lazy"})}),c.jsxs("div",{className:"msg-attachment-meta",children:[c.jsx("span",{className:"msg-attachment-name",children:y.name}),b&&c.jsx("span",{className:"msg-attachment-size",children:b}),c.jsx("a",{className:"msg-attachment-download",href:y.dataUrl,download:y.name,children:"Download"})]})]}):e.messageContent,c.jsx("span",{className:"msg-time",children:new Date(e.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),c.jsxs("div",{className:`wa-message-actions ${o?"visible":""} ${p?"mine":"theirs"}`,children:[c.jsx(qt,{visible:o,activeEmoji:x,onSelect:j}),o&&c.jsx("button",{type:"button",className:"wa-reply-action",onMouseDown:e=>{e.preventDefault()},onClick:()=>{s?.(e),a(!1)},"aria-label":"Reply to message",title:"Reply",children:"Reply"}),o&&i&&c.jsx("button",{type:"button",className:"wa-delete-action",onMouseDown:e=>{e.preventDefault()},onClick:()=>{i?.(e),a(!1)},"aria-label":"Delete message",title:"Delete message",children:"Delete"})]}),S.length>0&&c.jsx("div",{className:"wa-reaction-summary",role:"group","aria-label":"Message reactions",children:S.map(e=>c.jsxs("button",{type:"button",className:"wa-reaction-chip "+(e.reactedByMe?"mine":""),onClick:()=>j(e.emoji),"aria-label":`Reaction ${e.emoji} with count ${e.count}`,children:[c.jsx("span",{children:e.emoji}),c.jsx("span",{children:e.count})]},e.emoji))})]})},(e,t)=>e.message===t.message&&e.currentUserId===t.currentUserId&&e.onReact===t.onReact&&e.onOpenSenderProfile===t.onOpenSenderProfile&&e.onReply===t.onReply&&e.onDelete===t.onDelete),Ht="P-256",Yt="AES-GCM",Zt="e2e_dm_v1";function Jt(e){return null==e?"":String(e).trim()}function Gt(e){let t="";for(let r=0;r<e.length;r+=32768){const n=e.subarray(r,r+32768);t+=String.fromCharCode(...n)}return btoa(t)}function Xt(e){const t=atob(String(e||"")),r=new Uint8Array(t.length);for(let n=0;n<t.length;n+=1)r[n]=t.charCodeAt(n);return r}function Qt(){return"undefined"!=typeof window&&Boolean(window.crypto?.subtle)}async function er(e,t){const r=await window.crypto.subtle.exportKey(t,e);return Gt(new Uint8Array(r))}async function tr(e){return window.crypto.subtle.importKey("pkcs8",Xt(e),{name:"ECDH",namedCurve:Ht},!1,["deriveBits"])}async function rr(e){return window.crypto.subtle.importKey("raw",Xt(e),{name:"ECDH",namedCurve:Ht},!1,[])}async function nr(e,t){const r=await tr(e),n=await rr(t),s=await window.crypto.subtle.deriveBits({name:"ECDH",public:n},r,256);return window.crypto.subtle.importKey("raw",s,{name:Yt},!1,["encrypt","decrypt"])}function sr(e){try{const t=JSON.parse(String(e||""));if(!t||t.kind!==Zt)return null;const r=Jt(t.iv),n=Jt(t.ciphertext),s=Jt(t.senderPublicKey),i=Jt(t.recipientPublicKey),o=Number(t.version||0),a=Jt(t.algorithm||"");return r&&n&&s&&i?1!==o||a!==Yt?null:{kind:t.kind,version:o,algorithm:a,iv:r,ciphertext:n,senderPublicKey:s,recipientPublicKey:i}:null}catch{return null}}function ir(){return Qt()}async function or(e){const t=Jt(e);if(!t)throw new Error("Missing user id for E2EE identity setup.");if(!Qt())throw new Error("This browser does not support Web Crypto.");const r=function(e){const t=Jt(e);return{privateKey:`chatapp-e2ee-private:${t}`,publicKey:`chatapp-e2ee-public:${t}`}}(t);let n="",s="";try{n=Jt(window.localStorage.getItem(r.privateKey)),s=Jt(window.localStorage.getItem(r.publicKey))}catch{}if(n&&s){if(await async function(e,t){try{return await Promise.all([tr(e),rr(t)]),!0}catch{return!1}}(n,s))return{privateKey:n,publicKey:s}}const i=await window.crypto.subtle.generateKey({name:"ECDH",namedCurve:Ht},!0,["deriveBits"]),o=await er(i.privateKey,"pkcs8"),a=await er(i.publicKey,"raw");try{window.localStorage.setItem(r.privateKey,o),window.localStorage.setItem(r.publicKey,a)}catch{}return{privateKey:o,publicKey:a}}const ar="https://real-time-chatapp-o0me.onrender.com".replace(/\/$/,""),cr=[{urls:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302"]},{urls:["stun:openrelay.metered.ca:80"]},{urls:["turn:openrelay.metered.ca:80","turn:openrelay.metered.ca:443","turns:openrelay.metered.ca:443"],username:"openrelayproject",credential:"openrelayproject"}];function lr(e){if(!e||"object"!=typeof e)return null;const t=(Array.isArray(e.urls)?e.urls:[e.urls]).map(e=>String(e||"").trim()).filter(Boolean);if(0===t.length)return null;const r=String(e.username||"").trim(),n=String(e.credential||"").trim();return{urls:t,...r?{username:r}:{},...n?{credential:n}:{}}}const dr={iceServers:function(){const e=String("").trim();if(!e)return cr;try{const t=JSON.parse(e),r=(Array.isArray(t)?t:[t]).map(lr).filter(Boolean);return r.length>0?r:cr}catch(t){return console.error("Invalid VITE_WEBRTC_ICE_SERVERS value. Falling back to default ICE servers.",t),cr}}(),iceCandidatePoolSize:10},ur={status:"idle",callType:"audio",peerUserId:"",peerName:"",callId:"",error:""},hr={incoming:"Incoming call",outgoing:"Calling...",connecting:"Connecting...",connected:"In call"},pr=5242880,mr="chat_attachment",fr="[Unable to decrypt message]";function gr(e){return"video"===e?"video":"audio"}function yr(e="user"){return`${e}-${Date.now()}-${Math.random().toString(36).slice(2,8)}`}function vr(e){if(!e||"object"!=typeof e)return null;const t="offer"===e.type||"answer"===e.type?e.type:"",r="string"==typeof e.sdp?e.sdp:"";return t&&r?{type:t,sdp:r}:null}function br(e){if(!e)return null;const t="function"==typeof e.toJSON?e.toJSON():e;if(!t||"object"!=typeof t)return null;const r=String(t.candidate||"").trim();if(!r)return null;const n={candidate:r};return"string"==typeof t.sdpMid&&(n.sdpMid=t.sdpMid),"number"==typeof t.sdpMLineIndex&&(n.sdpMLineIndex=t.sdpMLineIndex),"string"==typeof t.usernameFragment&&(n.usernameFragment=t.usernameFragment),n}function wr(e){if(!e)return"";if("string"==typeof e)return e;if("object"==typeof e&&e._id)return String(e._id);if("function"==typeof e?.toString){const t=e.toString();if(t&&"[object Object]"!==t)return t}return""}function xr(e){return`room:${e}`}function Sr(e){return`dm:${e}`}function jr(e){const t=function(e){const t=String(e||"").trim();if(!t)return null;try{const e=JSON.parse(t);return e&&e.kind===mr&&"string"==typeof e.dataUrl?{name:String(e.name||"attachment"),mimeType:String(e.mimeType||""),size:Number(e.size)||0,dataUrl:e.dataUrl}:null}catch{return null}}(e);if(t){return`${t.mimeType.startsWith("image/")?"Image":"File"}: ${t.name}`}const r=String(e||"").trim();return r?r.length>90?`${r.slice(0,90)}...`:r:"New message"}function Cr(e){return e&&(e.displayName||e.username||e.name||e.email)||"Unknown"}function _r(e){if(!e||"object"!=typeof e)return"";const t=[e.avatarUrl,e.avatar,e.profilePicture,e.photoUrl,e.photoURL,e.image];for(const r of t){let e="";if("string"==typeof r?e=r.trim():r&&"object"==typeof r&&(e=String(r.url||r.secure_url||r.src||"").trim()),e){if(e.startsWith("data:")||e.startsWith("blob:")||/^https?:\/\//i.test(e))return e;if(e.startsWith("//")){return`${"undefined"!=typeof window?window.location.protocol:"https:"}${e}`}return e.startsWith("/")?`${ar}${e}`:`${ar}/${e.replace(/^\/+/,"")}`}}return""}function kr(e){return{...e,displayName:Cr(e),avatarUrl:_r(e)}}function Nr(e){return String(e||"").trim().toLowerCase()}function Er(e){return{user:wr(e?.user),emoji:e?.emoji||""}}function Rr(e){return e&&"object"==typeof e?{_id:wr(e),senderUserId:e.senderUserId||null,messageContent:String(e.messageContent||""),createdAt:e.createdAt||""}:null}function Tr(e,t){return!!(e&&Array.isArray(e.members)&&t)&&e.members.some(e=>String(wr(e))===String(t))}function Ar(e,t){if(!e)return!1;const r=Rr(e.replyTo),n=Rr(t.replyTo),s=!r&&!n||Boolean(r)&&Boolean(n)&&r._id===n._id&&r.messageContent===n.messageContent&&wr(r.senderUserId)===wr(n.senderUserId)&&String(r.createdAt)===String(n.createdAt);return String(e._id)===String(t._id)&&e.messageContent===t.messageContent&&e.messageType===t.messageType&&e.readStatus===t.readStatus&&String(e.createdAt)===String(t.createdAt)&&String(e.updatedAt)===String(t.updatedAt)&&wr(e.senderUserId)===wr(t.senderUserId)&&function(e=[],t=[]){if(e.length!==t.length)return!1;for(let r=0;r<e.length;r+=1){const n=Er(e[r]),s=Er(t[r]);if(n.user!==s.user||n.emoji!==s.emoji)return!1}return!0}(e.reactions||[],t.reactions||[])&&s}function Ir(e,t){const r=new Map(e.map(e=>[String(e._id),e]));return t.map(e=>{const t={...e,reactions:Array.isArray(e.reactions)?e.reactions:[],replyTo:Rr(e.replyTo)},n=r.get(String(t._id));return Ar(n,t)?n:t})}function Pr({theme:e}){return"light"===e?c.jsx("svg",{className:"header-icon",viewBox:"0 0 24 24","aria-hidden":"true",children:c.jsx("path",{d:"M21 12.8A9 9 0 1 1 11.2 3a7 7 0 0 0 9.8 9.8Z",fill:"none",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round",strokeLinejoin:"round"})}):c.jsxs("svg",{className:"header-icon",viewBox:"0 0 24 24","aria-hidden":"true",children:[c.jsx("circle",{cx:"12",cy:"12",r:"4.2",fill:"none",stroke:"currentColor",strokeWidth:"1.8"}),c.jsx("path",{d:"M12 2.5v2.3M12 19.2v2.3M4.7 4.7l1.6 1.6M17.7 17.7l1.6 1.6M2.5 12h2.3M19.2 12h2.3M4.7 19.3l1.6-1.6M17.7 6.3l1.6-1.6",fill:"none",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round"})]})}function Mr(){return c.jsxs("svg",{className:"header-icon",viewBox:"0 0 24 24","aria-hidden":"true",children:[c.jsx("path",{d:"M10 3H7.8A2.8 2.8 0 0 0 5 5.8v12.4A2.8 2.8 0 0 0 7.8 21H10",fill:"none",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round"}),c.jsx("path",{d:"M14.5 8.5 19 12l-4.5 3.5M19 12H10",fill:"none",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round",strokeLinejoin:"round"})]})}function Or(){return c.jsxs("svg",{className:"header-icon",viewBox:"0 0 24 24","aria-hidden":"true",children:[c.jsx("circle",{cx:"12",cy:"12",r:"8.5",fill:"none",stroke:"currentColor",strokeWidth:"1.8"}),c.jsx("circle",{cx:"9",cy:"10",r:"1.05",fill:"currentColor"}),c.jsx("circle",{cx:"15",cy:"10",r:"1.05",fill:"currentColor"}),c.jsx("path",{d:"M8.6 14.2c.9 1.3 2.1 1.9 3.4 1.9s2.5-.6 3.4-1.9",fill:"none",stroke:"currentColor",strokeWidth:"1.6",strokeLinecap:"round"})]})}function Ur(){return c.jsx("svg",{className:"header-icon",viewBox:"0 0 24 24","aria-hidden":"true",children:c.jsx("path",{d:"M15.5 6.5 8.6 13.4a3.1 3.1 0 1 0 4.4 4.4l7-7a5 5 0 0 0-7.1-7.1l-7.2 7.2a7 7 0 0 0 9.9 9.9l5.8-5.8",fill:"none",stroke:"currentColor",strokeWidth:"1.7",strokeLinecap:"round",strokeLinejoin:"round"})})}function Dr(){return c.jsx("svg",{className:"header-icon",viewBox:"0 0 24 24","aria-hidden":"true",children:c.jsx("path",{d:"M6.4 3.4c.7-.7 1.8-.7 2.5 0l1.9 1.9c.7.7.7 1.8 0 2.5l-1.1 1.1a14.3 14.3 0 0 0 5.4 5.4l1.1-1.1c.7-.7 1.8-.7 2.5 0l1.9 1.9c.7.7.7 1.8 0 2.5l-1.2 1.2c-.9.9-2.2 1.3-3.5 1-2.5-.6-5.2-2.1-7.7-4.6s-4-5.2-4.6-7.7c-.3-1.3.1-2.6 1-3.5l1.2-1.2Z",fill:"none",stroke:"currentColor",strokeWidth:"1.6",strokeLinecap:"round",strokeLinejoin:"round"})})}function Lr(){return c.jsxs("svg",{className:"header-icon",viewBox:"0 0 24 24","aria-hidden":"true",children:[c.jsx("rect",{x:"3",y:"6",width:"13",height:"12",rx:"2",fill:"none",stroke:"currentColor",strokeWidth:"1.6"}),c.jsx("path",{d:"M16 10.2 21 7.5v9l-5-2.7v-3.6Z",fill:"none",stroke:"currentColor",strokeWidth:"1.6",strokeLinecap:"round",strokeLinejoin:"round"})]})}function Br(){return c.jsx("svg",{className:"no-chat-icon-svg",viewBox:"0 0 24 24","aria-hidden":"true",children:c.jsx("path",{d:"M6.5 18.5 3 21V5.8A2.8 2.8 0 0 1 5.8 3h12.4A2.8 2.8 0 0 1 21 5.8v9.4A2.8 2.8 0 0 1 18.2 18H6.5Z",fill:"none",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round",strokeLinejoin:"round"})})}function zr({theme:e,setTheme:t}){const[r,s]=l.useState([]),[i,o]=l.useState([]),[a,d]=l.useState(null),[u,h]=l.useState(null),[p,m]=l.useState([]),[f,g]=l.useState(""),[y,v]=l.useState(null),[b,w]=l.useState(""),[x,S]=l.useState(!1),[j,C]=l.useState("chats"),[E,R]=l.useState(""),[T,A]=l.useState(!1),[I,P]=l.useState(!1),[M,O]=l.useState({}),[U,D]=l.useState(!1),[L,B]=l.useState(""),[z,$]=l.useState(""),[F,q]=l.useState({type:"",userId:""}),[W,K]=l.useState(!1),[V,H]=l.useState(!1),[Y,Z]=l.useState(!1),[J,G]=l.useState(!1),[X,Q]=l.useState(null),[ee,te]=l.useState({}),[re,ne]=l.useState(ur),[se,ie]=l.useState(null),[oe,ae]=l.useState(null),[ce,le]=l.useState(!1),[de,ue]=l.useState(!1),[he,pe]=l.useState(()=>k().userId),[me,fe]=l.useState(()=>k().username),[ge,ye]=l.useState(()=>k().token),[ve,be]=l.useState(()=>{const e=k();return kr({_id:e.userId||"",username:e.username||"",bio:"",phoneNumber:"",email:"",avatarUrl:""})}),we=l.useRef(null),xe=l.useRef(null),Se=l.useRef(null),je=l.useRef(null),Ce=l.useRef(null),_e=l.useRef(null),ke=l.useRef(null),Ne=l.useRef(!1),Ee=l.useRef(null),Re=l.useRef(null),Te=l.useRef(null),Ae=l.useRef(null),Ie=l.useRef(null),Pe=l.useRef(null),Me=l.useRef(null),Oe=l.useRef([]),Ue=l.useRef(""),De=l.useRef(""),Le=l.useRef("audio"),Be=l.useRef([]),ze=l.useRef(""),$e=l.useRef(new Set),Fe=l.useRef(!1),qe=l.useRef(null),We=l.useRef(""),Ke=l.useRef(""),Ve=l.useRef(!1),[He,Ye]=l.useState(()=>localStorage.getItem("theme")||"light"),Ze=void 0!==e?e:He;l.useEffect(()=>{void 0===e&&(document.documentElement.setAttribute("data-theme",He),localStorage.setItem("theme",He))},[He,e]),l.useEffect(()=>{Be.current=i},[i]),l.useEffect(()=>{const e=()=>{const e=k();pe(e.userId),fe(e.username),ye(e.token),be(t=>kr({...t||{},_id:e.userId||t?._id||"",username:e.username||t?.username||""}))};return window.addEventListener("storage",e),()=>{window.removeEventListener("storage",e)}},[]);const Je=l.useCallback((e,t="")=>{if(t)return t;const r=Be.current.find(t=>String(t._id)===String(e));if(r)return Cr(r);if(e){return`User ${String(e).slice(-4)}`}return"Unknown"},[]),Ge=l.useMemo(()=>a?._id?xr(String(a._id)):u?._id?Sr(String(u._id)):"",[a?._id,u?._id]),Xe=l.useCallback(e=>{e&&te(t=>{if(!t[e])return t;const r={...t};return delete r[e],r})},[]);l.useEffect(()=>{ze.current=Ge,Xe(Ge)},[Ge,Xe]);const et=l.useCallback(e=>{const t=wr(e?.senderUserId),r=wr(e?.receiverUserIdOrRoomId),n=String(he||"");return t&&r&&n&&t!==n?r===n?Sr(t):xr(r):""},[he]),rt=l.useCallback(()=>{try{const e=window.AudioContext||window.webkitAudioContext;if(!e)return;qe.current||(qe.current=new e);const t=qe.current;"suspended"===t.state&&t.resume().catch(()=>{});const r=t.createOscillator(),n=t.createGain(),s=t.currentTime;r.type="sine",r.frequency.setValueAtTime(920,s),n.gain.setValueAtTime(1e-4,s),n.gain.exponentialRampToValueAtTime(.08,s+.02),n.gain.exponentialRampToValueAtTime(1e-4,s+.18),r.connect(n),n.connect(t.destination),r.start(s),r.stop(s+.2)}catch{}},[]),nt=l.useCallback((e,t)=>{if(!("Notification"in window))return;"visible"===document.visibilityState&&document.hasFocus()||("granted"!==Notification.permission?"default"!==Notification.permission||Fe.current||(Fe.current=!0,Notification.requestPermission().then(r=>{"granted"===r&&new Notification(e,{body:t,tag:"chat-new-message"})}).catch(()=>{})):new Notification(e,{body:t,tag:"chat-new-message"}))},[]);l.useEffect(()=>()=>{qe.current&&(qe.current.close().catch(()=>{}),qe.current=null)},[]);const st=l.useCallback(e=>{e?._id&&m(t=>{if(t.some(t=>String(t._id)===String(e._id)))return t;const r={...e,reactions:Array.isArray(e.reactions)?e.reactions:[],replyTo:Rr(e.replyTo)};return[...t,r]})},[]),it=l.useCallback(async(e,t,r)=>{const n=String(e||"");if(!n)return"";if(!r||!Boolean(sr(n)))return n;if(!he||!We.current)return fr;try{return await async function({payloadText:e,currentUserId:t,senderUserId:r,privateKeyBase64:n}){const s=sr(e);if(!s)throw new Error("Invalid encrypted message payload.");const i=Jt(n);if(!i)throw new Error("Missing local private key for message decryption.");if(!Qt())throw new Error("This browser does not support Web Crypto.");const o=Jt(t),a=Jt(r),c=o&&o===a?s.recipientPublicKey:s.senderPublicKey;if(!c)throw new Error("Missing peer key in encrypted payload.");const l=await nr(i,c),d=await window.crypto.subtle.decrypt({name:Yt,iv:Xt(s.iv)},l,Xt(s.ciphertext));return(new TextDecoder).decode(d)}({payloadText:n,currentUserId:he,senderUserId:wr(t),privateKeyBase64:We.current})}catch(s){return console.error("Failed to decrypt message payload:",s),fr}},[he]),ot=l.useCallback(async e=>{if(!e||"object"!=typeof e)return null;const t=await it(e.messageContent,e.senderUserId,e.isEncrypted);let r=Rr(e.replyTo);if(e.replyTo&&"object"==typeof e.replyTo){const t=await it(e.replyTo.messageContent,e.replyTo.senderUserId,e.replyTo.isEncrypted??e.isEncrypted);r={_id:wr(e.replyTo),senderUserId:e.replyTo.senderUserId||null,messageContent:String(t??""),createdAt:e.replyTo.createdAt||""}}return{...e,messageContent:String(t??""),reactions:Array.isArray(e.reactions)?e.reactions:[],replyTo:r}},[it]),at=l.useCallback(async e=>{const t=Array.isArray(e)?e:[];return(await Promise.all(t.map(e=>ot(e)))).filter(Boolean)},[ot]);l.useEffect(()=>{if(!he||!ge)return We.current="",void(Ke.current="");if(!ir())return Ve.current||(console.warn("Web Crypto is not available. Direct-message E2EE is disabled."),Ve.current=!0),We.current="",void(Ke.current="");let e=!1;return(async()=>{try{const t=await or(he);if(e)return;We.current=t.privateKey,Ke.current=t.publicKey;const r=String(ve?.e2ePublicKey||"").trim();if(t.publicKey&&t.publicKey!==r){if(await n.put(`${ar}/api/users/${he}/update`,{e2ePublicKey:t.publicKey}),e)return;be(e=>kr({...e||{},_id:he,e2ePublicKey:t.publicKey}))}}catch(t){console.error("Failed to initialize E2EE identity:",t),We.current="",Ke.current=""}})(),()=>{e=!0}},[he,ve?.e2ePublicKey,ge]);const ct=l.useCallback((e="",t={})=>{const{skipStateUpdate:r=!1}=t;if(Ae.current){try{Ae.current.ontrack=null,Ae.current.onicecandidate=null,Ae.current.onconnectionstatechange=null,Ae.current.oniceconnectionstatechange=null,Ae.current.onicecandidateerror=null,Ae.current.close()}catch{}Ae.current=null}Ie.current&&(Ie.current.getTracks().forEach(e=>e.stop()),Ie.current=null),Pe.current&&(Pe.current.getTracks().forEach(e=>e.stop()),Pe.current=null),Me.current=null,Oe.current=[],Ue.current="",De.current="",Le.current="audio",r||(ie(null),ae(null),le(!1),ue(!1),ne({...ur,error:e}))},[]),lt=l.useCallback(async()=>{const e=Ae.current;if(!e||!e.remoteDescription)return;const t=[...Oe.current];Oe.current=[];for(const n of t)try{await e.addIceCandidate(n)}catch(r){console.error("Failed to add queued ICE candidate:",r)}},[]),dt=l.useCallback(({notifyPeer:e=!0,reason:t="ended",errorMessage:r="",skipStateUpdate:n=!1}={})=>{const s=_e.current;e&&s&&Ue.current&&s.emit("call:end",{toUserId:Ue.current,callId:De.current||null,reason:t}),ct(r,{skipStateUpdate:n})},[ct]),ut=l.useCallback((e,t,r)=>{const n=_e.current;if(!n)throw new Error("Socket is not connected");if(Ae.current)try{Ae.current.close()}catch{}const s=new RTCPeerConnection(dr);return s.onicecandidate=r=>{const s=br(r.candidate);s&&e&&n.emit("call:ice-candidate",{toUserId:e,callId:t,candidate:s})},s.ontrack=e=>{const[t]=e.streams;if(t)return Pe.current=t,void ae(t);Pe.current||(Pe.current=new MediaStream),e.track&&(Pe.current.addTrack(e.track),ae(new MediaStream(Pe.current.getTracks())))},s.onconnectionstatechange=()=>{const e=s.connectionState;"connected"!==e?"failed"!==e?"disconnected"!==e?"closed"===e&&dt({notifyPeer:!1,reason:e}):ne(e=>"connected"===e.status?{...e,status:"connecting"}:e):dt({notifyPeer:!1,reason:"failed",errorMessage:"Call connection failed. Check your network or TURN server settings."}):ne(e=>({...e,status:"connected"}))},s.oniceconnectionstatechange=()=>{const e=s.iceConnectionState;"connected"!==e&&"completed"!==e?"failed"===e&&dt({notifyPeer:!1,reason:"failed",errorMessage:"Call connection failed. Check your network or TURN server settings."}):ne(e=>({...e,status:"connected"}))},s.onicecandidateerror=e=>{console.error("ICE candidate error:",{address:e.address,port:e.port,url:e.url,errorCode:e.errorCode,errorText:e.errorText})},Ae.current=s,Ue.current=String(e||""),De.current=t||"",Le.current=gr(r),s},[dt]),ht=l.useCallback(async e=>{if(!navigator.mediaDevices?.getUserMedia)throw new Error("Your browser does not support calling features.");Ie.current&&Ie.current.getTracks().forEach(e=>e.stop());const t=await navigator.mediaDevices.getUserMedia({audio:!0,video:"video"===gr(e)});return Ie.current=t,ie(t),t},[]),pt=l.useCallback(async e=>{if(!u?._id||!he)return;if("idle"!==re.status)return;const t=gr(e),r=String(u._id),n=Cr(u),s=yr(he);try{Oe.current=[];const e=await ht(t),i=ut(r,s,t);e.getTracks().forEach(t=>{i.addTrack(t,e)}),ne({status:"outgoing",callType:t,peerUserId:r,peerName:n,callId:s,error:""});const o=await i.createOffer();await i.setLocalDescription(o);const a=vr(i.localDescription||o);if(!a)throw new Error("Unable to create call offer.");_e.current?.emit("call:offer",{toUserId:r,callType:t,callId:s,offer:a,fromUserName:me||""}),ne(e=>"outgoing"===e.status?{...e,status:"connecting"}:e)}catch(i){console.error("Failed to start call:",i),dt({notifyPeer:!1,errorMessage:i?.message||"Unable to start call. Check microphone/camera permissions and try again."})}},[re.status,ut,he,dt,ht,u,me]),mt=l.useCallback(async()=>{const e=Me.current;if(!e)return;const{fromUserId:t,offer:r,callType:n,callId:s,peerName:i}=e;try{const e=await ht(n),o=ut(t,s,n);e.getTracks().forEach(t=>{o.addTrack(t,e)}),ne({status:"connecting",callType:n,peerUserId:t,peerName:i,callId:s,error:""});const a=vr(r);if(!a)throw new Error("Invalid call offer.");await o.setRemoteDescription(a),await lt();const c=await o.createAnswer();await o.setLocalDescription(c);const l=vr(o.localDescription||c);if(!l)throw new Error("Unable to create call answer.");_e.current?.emit("call:answer",{toUserId:t,callId:s,answer:l}),Me.current=null}catch(o){console.error("Failed to accept call:",o),_e.current?.emit("call:end",{toUserId:t,callId:s,reason:"error"}),dt({notifyPeer:!1,errorMessage:"Unable to accept call."})}},[ut,dt,lt,ht]),ft=l.useCallback(()=>{const e=Me.current;e&&(_e.current?.emit("call:end",{toUserId:e.fromUserId,callId:e.callId||null,reason:"declined"}),dt({notifyPeer:!1}))},[dt]),gt=l.useCallback(()=>{const e=Ie.current;if(!e)return;const t=e.getAudioTracks();if(0===t.length)return;const r=t.some(e=>e.enabled);t.forEach(e=>{e.enabled=!r}),le(r)},[]),yt=l.useCallback(()=>{const e=Ie.current;if(!e)return;const t=e.getVideoTracks();if(0===t.length)return;const r=t.some(e=>e.enabled);t.forEach(e=>{e.enabled=!r}),ue(r)},[]);l.useEffect(()=>{Ee.current&&(Ee.current.srcObject=se||null)},[se]),l.useEffect(()=>{Re.current&&(Re.current.srcObject=oe||null),Te.current&&(Te.current.srcObject=oe||null)},[oe]),l.useEffect(()=>{if(!re.error)return;const e=window.setTimeout(()=>{ne(e=>e.error?{...e,error:""}:e)},4e3);return()=>{window.clearTimeout(e)}},[re.error]),l.useEffect(()=>{ge&&he||(window.location.href="/")},[ge,he]),l.useEffect(()=>{if(!ge)return delete n.defaults.headers.common.Authorization,void delete n.defaults.headers.common["x-auth-token"];n.defaults.headers.common.Authorization=`Bearer ${ge}`,n.defaults.headers.common["x-auth-token"]=ge},[ge]),l.useEffect(()=>{if(!he)return;const e=Qe(ar,{auth:{userId:he},query:{userId:he},transports:["websocket","polling"]});_e.current=e;const t=$e.current,r=e=>{e?.messageId&&Array.isArray(e.reactions)&&m(t=>{let r=!1;const n=t.map(t=>String(t._id)!==String(e.messageId)?t:(r=!0,{...t,reactions:e.reactions}));return r?n:t})},n=(e={})=>{const t=e?.messageId?String(e.messageId):"";t&&(m(e=>{let r=!1;const n=e.filter(e=>{const n=String(e._id)!==t;return n||(r=!0),n}).map(e=>{const n=wr(e.replyTo);return n&&String(n)===t?(r=!0,{...e,replyTo:null}):e});return r?n:e}),v(e=>e&&String(e._id)===t?null:e))},i=(e={})=>{const t=e?.receiverUserIdOrRoomId?String(e.receiverUserIdOrRoomId):"";if(!t)return;const r=Sr(t),n=xr(t);Xe(r),Xe(n);(ze.current===r||ze.current===n)&&(m([]),v(null))},o=async(e={})=>{const r=e?.data||e?.message||e,n=r?._id?String(r._id):"";if(!n)return;if(t.has(n))return;if(t.add(n),t.size>500){const e=t.values().next().value;t.delete(e)}const s=await ot(r);if(!s)return;const i=et(s);if(!i)return;const o=Cr(s.senderUserId),a=jr(s.messageContent),c=i===ze.current,l="visible"===document.visibilityState&&document.hasFocus();if(c)return st(s),void(l||(rt(),nt(o,a)));te(e=>({...e,[i]:(e[i]||0)+1})),rt(),nt(o,a)},a=e=>{if(!e)return;const t=String(e),r=xr(t);s(e=>e.filter(e=>String(e._id)!==t)),d(e=>e&&String(e._id)===t?null:e),te(e=>{if(!e[r])return e;const t={...e};return delete t[r],t})},c=(e={})=>{const t=e?.room;t?._id&&(Tr(t,he)?(s(e=>e.some(e=>String(e._id)===String(t._id))?e.map(e=>String(e._id)===String(t._id)?t:e):[t,...e]),d(e=>e&&String(e._id)===String(t._id)?t:e)):a(t._id))},l=(e={})=>{a(e?.roomId||e?.room?._id)},u=(t={})=>{const r=t?.fromUserId?String(t.fromUserId):"",n=vr(t?.offer);if(!r||!n)return;const s=gr(t?.callType),i=t?.callId||yr(r),o=Je(r,t?.fromUserName||"");Boolean(Me.current||Ue.current||Ae.current)?e.emit("call:end",{toUserId:r,callId:i,reason:"busy"}):(Oe.current=[],Me.current={fromUserId:r,callType:s,callId:i,offer:n,peerName:o},Ue.current=r,De.current=i,Le.current=s,ne({status:"incoming",callType:s,peerUserId:r,peerName:o,callId:i,error:""}))},h=async(e={})=>{if(e?.callId&&De.current&&String(e.callId)!==String(De.current))return;const t=Ae.current,r=vr(e?.answer);if(t&&r)try{await t.setRemoteDescription(r),await lt(),ne(e=>"incoming"===e.status?e:{...e,status:"connecting"})}catch(n){console.error("Failed to apply call answer:",n),dt({notifyPeer:!1,errorMessage:"Failed to connect call."})}},p=async(e={})=>{const t=br(e?.candidate);if(t&&(!e?.callId||!De.current||String(e.callId)===String(De.current)))try{const e=new RTCIceCandidate(t),r=Ae.current;if(!r||!r.remoteDescription)return void Oe.current.push(e);await r.addIceCandidate(e)}catch(r){console.error("Failed to apply ICE candidate:",r)}},f=(e={})=>{if(e?.callId&&De.current&&String(e.callId)!==String(De.current))return;const t=e?.reason||"ended";dt("busy"!==t?"declined"!==t?{notifyPeer:!1}:{notifyPeer:!1,errorMessage:"Call declined."}:{notifyPeer:!1,errorMessage:"User is busy on another call."})};return e.on("message:reaction_updated",r),e.on("message:new",o),e.on("message:deleted",n),e.on("conversation:cleared",i),e.on("room:membership_changed",c),e.on("room:removed",l),e.on("call:offer",u),e.on("call:answer",h),e.on("call:ice-candidate",p),e.on("call:end",f),()=>{e.off("message:reaction_updated",r),e.off("message:new",o),e.off("message:deleted",n),e.off("conversation:cleared",i),e.off("room:membership_changed",c),e.off("room:removed",l),e.off("call:offer",u),e.off("call:answer",h),e.off("call:ice-candidate",p),e.off("call:end",f),dt({notifyPeer:!1,skipStateUpdate:!0}),e.disconnect(),_e.current=null,ke.current=null,t.clear()}},[st,Xe,he,dt,lt,et,ot,rt,Je,nt]);const vt=l.useMemo(()=>{return he?a?._id?`room:${a._id}`:u?._id?(e=he,t=u._id,`dm:${[e,t].sort().join(":")}`):null:null;var e,t},[he,a,u]);l.useEffect(()=>{const e=_e.current;if(!e)return;const t=ke.current;if(t&&t!==vt&&e.emit("conversation:leave",{conversationId:t}),vt&&t!==vt)return e.emit("conversation:join",{conversationId:vt}),void(ke.current=vt);vt||(ke.current=null)},[vt]);const bt=l.useCallback(async()=>{if(a?._id){const e=await n.get(`${ar}/api/messages/${a._id}`),t=await at(e.data||[]);return void m(e=>Ir(e,t))}if(u?._id&&he){const e=await n.get(`${ar}/api/messages/between/${he}/${u._id}`),t=await at(e.data||[]);m(e=>Ir(e,t))}},[he,at,a,u]);l.useEffect(()=>{if(!a&&!u)return void m([]);bt().catch(e=>{console.error("Failed to fetch messages:",e)});const e=window.setInterval(()=>{bt().catch(e=>{console.error("Message polling failed:",e)})},2500);return()=>{window.clearInterval(e)}},[bt,a,u]),l.useEffect(()=>{v(null)},[a?._id,u?._id]),l.useEffect(()=>{we.current?.scrollIntoView({behavior:"smooth",block:"nearest"})},[p.length]),l.useEffect(()=>{const e=xe.current;e&&(e.style.height="auto",e.style.height=`${Math.min(e.scrollHeight,160)}px`)},[f]),l.useEffect(()=>{if(!he)return;(async()=>{try{H(!0);const[e,t]=await Promise.all([n.get(`${ar}/api/chatrooms`,{params:{memberId:he}}),n.get(`${ar}/api/users`)]),r=Array.isArray(e.data)?e.data:[];s(r.filter(e=>Tr(e,he)));const i=(t.data||[]).map(kr),a=i.find(e=>String(e._id)===String(he));a&&(be(a),a.username&&fe(a.username));const c=i.filter(e=>String(e._id)!==String(he));o(c)}catch(e){console.error("Failed to fetch rooms/users:",e)}finally{H(!1)}})()},[he]);const wt=l.useCallback(async()=>{if(he)try{const[e,t]=await Promise.all([n.get(`${ar}/api/users/${he}/following`),n.get(`${ar}/api/users/${he}/sent-follow-requests`)]),r={};(e.data.following||[]).forEach(e=>{r[e._id]="following"}),(t.data.sentRequests||[]).forEach(e=>{r[e._id]="pending"}),O(r)}catch(e){console.error("Failed to fetch follow status:",e)}},[he]);l.useEffect(()=>{wt()},[wt]),l.useEffect(()=>{if(!he)return;const e=window.setInterval(()=>{wt()},1e4);return()=>{window.clearInterval(e)}},[he,wt]);const xt=l.useCallback(e=>{e&&(s(t=>t.filter(t=>String(t._id)!==String(e))),d(t=>t&&String(t._id)===String(e)?null:t))},[]),St=l.useCallback(e=>{e?._id&&(Tr(e,he)?(s(t=>t.some(t=>String(t._id)===String(e._id))?t.map(t=>String(t._id)===String(e._id)?e:t):[e,...t]),d(t=>t&&String(t._id)===String(e._id)?e:t)):xt(e._id))},[he,xt]);l.useEffect(()=>{if(!a?._id)return;r.some(e=>String(e._id)===String(a._id))||(d(null),D(!1),$(""),q({type:"",userId:""}))},[r,a?._id]),l.useEffect(()=>{U&&a?._id&&n.get(`${ar}/api/chatrooms/${a._id}`).then(e=>{e.data?._id&&St(e.data)}).catch(e=>{console.error("Failed to refresh room details:",e)})},[St,a?._id,U]);const jt=l.useCallback(()=>{A(!1)},[]),Ct=l.useCallback(()=>{A(e=>!e)},[]);l.useEffect(()=>{Ne.current&&!T&&je.current?.focus(),Ne.current=T},[T]);const _t=l.useCallback(e=>{const t=xe.current;if(!t)return void g(t=>`${t}${e}`);const r=t.selectionStart??t.value.length,n=t.selectionEnd??t.value.length,s=t.value,i=s.slice(0,r)+e+s.slice(n);g(i),window.requestAnimationFrame(()=>{const n=r+e.length;t.focus(),t.setSelectionRange(n,n),t.style.height="auto",t.style.height=`${Math.min(t.scrollHeight,160)}px`})},[]),kt=l.useCallback(async e=>{const t=wr(e);if(!t)return"";const r=String(e?.e2ePublicKey||"").trim();if(r)return r;try{const e=await n.get(`${ar}/api/users/${t}`),r=String(e.data?.e2ePublicKey||"").trim();return r?(o(e=>e.map(e=>String(e._id)===String(t)?kr({...e,e2ePublicKey:r}):e)),h(e=>e&&String(e._id)===String(t)?kr({...e,e2ePublicKey:r}):e),r):""}catch(s){return console.error("Failed to fetch peer E2EE key:",s),""}},[]),Nt=l.useCallback(async({messageContent:e,messageType:t="text"})=>{const r=Boolean(u?._id)&&"following"!==(M[u._id]||"not_following"),s=a?._id||u?._id,i=String(e||""),o=Boolean(u?._id)&&!a?._id;if(!i||!s||r||!he)return!1;let c=i,l=!1,d="none";if(o){if(!ir())throw new Error("This browser does not support end-to-end encryption.");const e=We.current,t=Ke.current,r=await kt(u);if(!e||!t||!r)throw new Error("Encryption keys are not ready. Ask both users to refresh and try again.");c=await async function({plainText:e,senderPrivateKeyBase64:t,senderPublicKeyBase64:r,recipientPublicKeyBase64:n}){const s=Jt(t),i=Jt(r),o=Jt(n);if(!s||!i||!o)throw new Error("Missing encryption keys for direct-message E2EE.");if(!Qt())throw new Error("This browser does not support Web Crypto.");const a=await nr(s,o),c=window.crypto.getRandomValues(new Uint8Array(12)),l=(new TextEncoder).encode(String(e??"")),d=await window.crypto.subtle.encrypt({name:Yt,iv:c},a,l);return JSON.stringify({kind:Zt,version:1,algorithm:Yt,iv:Gt(c),ciphertext:Gt(new Uint8Array(d)),senderPublicKey:i,recipientPublicKey:o})}({plainText:i,senderPrivateKeyBase64:e,senderPublicKeyBase64:t,recipientPublicKeyBase64:r}),l=!0,d="E2EE-AES-GCM"}const h=await n.post(`${ar}/api/messages/send`,{senderUserId:he,receiverUserIdOrRoomId:s,messageContent:c,messageType:t,replyToMessageId:y?._id||null,isEncrypted:l,encryptionMethod:d}),p=await ot(h.data?.data);return p?._id&&st(p),A(!1),v(null),!0},[st,he,kt,ot,y?._id,a,u,M]),Et=l.useCallback(async()=>{const e=f.trim();if(e)try{if(!(await Nt({messageContent:e,messageType:"text"})))return;g(""),xe.current&&(xe.current.style.height="auto")}catch(t){console.error("Failed to send message:",t),alert(t.response?.data?.message||t.message||"Failed to send message")}},[f,Nt]),Rt=l.useCallback(()=>{Ce.current?.click()},[]),Tt=l.useCallback(async e=>{const t=e.target.files?.[0];var r;if(e.target.value="",t)if(t.size>pr)alert(`File is too large. Maximum allowed size is ${function(e){if(!Number.isFinite(e)||e<=0)return"0 B";const t=["B","KB","MB","GB"];let r=e,n=0;for(;r>=1024&&n<t.length-1;)r/=1024,n+=1;const s=r>=10||0===n?0:1;return`${r.toFixed(s)} ${t[n]}`}(pr)}.`);else try{P(!0);const e=await(r=t,new Promise((e,t)=>{const n=new FileReader;n.onload=()=>{e(String(n.result||""))},n.onerror=()=>{t(n.error||new Error("Failed to read file"))},n.readAsDataURL(r)}));if(!e)throw new Error("File payload unavailable");const n=JSON.stringify({kind:mr,name:t.name||"attachment",mimeType:t.type||"application/octet-stream",size:t.size||0,dataUrl:e});await Nt({messageContent:n,messageType:t.type.startsWith("image/")?"image":"file"})}catch(n){console.error("Failed to send file:",n),alert(n.response?.data?.message||n.message||"Failed to upload file")}finally{P(!1)}},[Nt]),At=l.useCallback(async(e,t)=>{try{const r=await n.put(`${ar}/api/messages/${e}/reactions`,{userId:he,emoji:t}),s=r.data?.data?.reactions||[];m(t=>{let r=!1;const n=t.map(t=>String(t._id)!==String(e)?t:(r=!0,{...t,reactions:s}));return r?n:t})}catch(r){console.error("Failed to update reaction:",r)}},[he]),Mt=l.useCallback(e=>{e?._id&&(v({_id:String(e._id),senderUserId:e.senderUserId||null,messageContent:String(e.messageContent||""),createdAt:e.createdAt||""}),xe.current?.focus())},[]),Ot=l.useCallback(async e=>{const t=e?._id?String(e._id):"";if(!t||!he)return;if(window.confirm("Delete this message?"))try{await n.delete(`${ar}/api/messages/${t}`,{data:{actorUserId:he}}),m(e=>e.filter(e=>String(e._id)!==t).map(e=>wr(e.replyTo)===t?{...e,replyTo:null}:e)),v(e=>e&&String(e._id)===t?null:e)}catch(r){alert(r.response?.data?.message||"Failed to delete message")}},[he]),Ut=l.useCallback(async()=>{const e=a?._id||u?._id;if(!e||!he||W)return;const t=a?"Delete all messages in this room chat? This will affect all room members.":"Delete all messages in this direct chat?";if(window.confirm(t))try{K(!0),await n.delete(`${ar}/api/messages/conversation/clear`,{data:{actorUserId:he,receiverUserIdOrRoomId:e}}),m([]),v(null),Xe(xr(String(e))),Xe(Sr(String(e)))}catch(r){alert(r.response?.data?.message||"Failed to clear conversation")}finally{K(!1)}},[Xe,he,W,a,u]),Dt=l.useCallback(async()=>{if(b.trim())try{await n.post(`${ar}/api/chatrooms/create`,{roomName:b.trim(),createdBy:he}),w(""),S(!1),B("");const e=await n.get(`${ar}/api/chatrooms`,{params:{memberId:he}}),t=Array.isArray(e.data)?e.data:[];s(t.filter(e=>Tr(e,he)))}catch(e){B(e.response?.data?.message||"Failed to create room")}},[he,b]),Lt=l.useCallback(async e=>{if(a?._id&&e)try{$(""),q({type:"add",userId:String(e)});const t=await n.post(`${ar}/api/chatrooms/${a._id}/members`,{userId:e,actorId:he});t.data?.room&&St(t.data.room)}catch(t){$(t.response?.data?.message||"Failed to add member")}finally{q({type:"",userId:""})}},[St,he,a]),Bt=l.useCallback(async e=>{if(a?._id&&e)try{$(""),q({type:"remove",userId:String(e)});const t=await n.delete(`${ar}/api/chatrooms/${a._id}/members/${e}`,{data:{actorId:he}});t.data?.room&&St(t.data.room)}catch(t){$(t.response?.data?.message||"Failed to remove member")}finally{q({type:"",userId:""})}},[St,he,a]),zt=l.useCallback(()=>{t?t(e=>"light"===e?"dark":"light"):Ye(e=>"light"===e?"dark":"light")},[t]),Ft=l.useCallback(async()=>{dt({notifyPeer:!0,reason:"logout"});try{await n.post(`${ar}/api/users/${he}/logout`)}catch(e){console.error("Logout call failed:",e)}!function(){if("undefined"!=typeof window)try{_(window.sessionStorage),_(window.localStorage)}catch{}}(),window.location.href="/"},[he,dt]),qt=l.useCallback(e=>{const t=kr(e||{}),r=t.username||t.displayName||"";fe(r),be(e=>kr({...e||{},...t,_id:t._id||e?._id||he,username:r||e?.username||""})),o(e=>e.map(e=>String(e._id)===String(t._id)?kr({...e,...t}):e)),h(e=>e&&String(e._id)===String(t._id)?kr({...e,...t}):e),Q(e=>e&&String(e._id)===String(t._id)?kr({...e,...t}):e),he&&ge&&N({userId:he,username:r,token:ge})},[he,ge]),Wt=l.useCallback(e=>{const t=wr(e);if(!t)return;const r=kr("object"==typeof e?{...e,_id:t}:{_id:t}),n=Be.current.find(e=>String(e._id)===String(t)),s=n?kr({...r,...n,_id:t,avatarUrl:_r(n)||r.avatarUrl,displayName:n.displayName||r.displayName}):r;Q(s),G(!0)},[]),Kt=l.useMemo(()=>a?.members||[],[a]),Ht=a?wr(a.createdBy):"",er=a?Cr(a.createdBy):"",tr=Boolean(a?._id)&&String(Ht)===String(he),rr=Boolean(a?._id)&&Nr(er)===Nr(me),cr=tr||rr,lr=l.useMemo(()=>new Set(Kt.flatMap(e=>{const t=String(wr(e)),r=Nr(Cr(e)),n=[];return t&&n.push(`id:${t}`),r&&n.push(`name:${r}`),n})),[Kt]),Er=l.useMemo(()=>i.filter(e=>{const t=String(wr(e)),r=Nr(Cr(e));return!lr.has(`id:${t}`)&&!lr.has(`name:${r}`)}),[lr,i]),Ar=a?.roomName||u?.displayName||"",zr=a?`${a.members?.length||0} members`:u?.onlineStatus?"Online":"Offline",$r=Ar?Ar.charAt(0).toUpperCase():"#",Fr=Boolean(a||u),qr=_r(ve),Wr=a?"":_r(u),Kr=l.useMemo(()=>Object.values(ee).reduce((e,t)=>e+t,0),[ee]),Vr=E.trim().toLowerCase(),Hr=l.useMemo(()=>Vr?i.filter(e=>Cr(e).toLowerCase().includes(Vr)):i,[Vr,i]),Yr=l.useMemo(()=>Vr?r.filter(e=>String(e.roomName||"").toLowerCase().includes(Vr)):r,[Vr,r]),Zr="people"===j?"Search users":"Search rooms or users",Jr="idle"===re.status,Gr=re.peerName||Je(re.peerUserId,u?.displayName||""),Xr=l.useMemo(()=>{if(u&&String(u._id)===String(re.peerUserId))return _r(u);if(re.peerUserId){return _r(i.find(e=>String(e._id)===String(re.peerUserId)))}return""},[re.peerUserId,u,i]),Qr=hr[re.status]||"",en=Boolean(se?.getVideoTracks?.().length),tn=!u?._id||!Jr,rn=a?cr:Boolean(u),nn=u?._id&&M[u._id]||"not_following",sn=!u||"following"===nn,on=Boolean(u)&&!sn,an=on?"pending"===nn?"Follow request pending...":"Follow this user to start messaging":"Type a message...",cn=on?"pending"===nn?`Your follow request to ${u?.displayName||"this user"} is pending approval.`:`Follow ${u?.displayName||"this user"} to send direct messages.`:"",ln=l.useMemo(()=>{const e=wr(y?.senderUserId);if(!e)return"Unknown";if(String(e)===String(he))return"You";if(u&&String(u._id)===String(e))return u.displayName||"Unknown";const t=i.find(t=>String(t._id)===String(e));return t?.displayName||y?.senderUserId?.username||"Unknown"},[he,y,u,i]),dn=jr(y?.messageContent||"Message unavailable");return c.jsxs("div",{className:"chat-container "+(Fr?"chat-open":""),children:[c.jsxs("div",{className:"chat-sidebar",children:[c.jsxs("div",{className:"sidebar-header",children:[c.jsx("h2",{children:"ChatApp"}),c.jsxs("div",{className:"header-actions",children:[c.jsx("button",{className:"icon-btn header-icon-btn",onClick:zt,title:"light"===Ze?"Switch to dark mode":"Switch to light mode","aria-label":"light"===Ze?"Switch to dark mode":"Switch to light mode",children:c.jsx(Pr,{theme:Ze})}),c.jsx("button",{className:"icon-btn danger header-icon-btn",onClick:Ft,title:"Logout","aria-label":"Logout",children:c.jsx(Mr,{})})]})]}),c.jsxs("div",{className:"user-profile-mini",children:[c.jsxs("div",{className:"user-info-group",onClick:()=>Z(!0),style:{cursor:"pointer"},title:"Edit Profile",children:[c.jsx("div",{className:"user-avatar-mini",style:qr?{backgroundImage:`url("${qr}")`}:void 0,children:qr?null:me?.charAt(0).toUpperCase()}),c.jsx("div",{className:"user-name-mini",children:me})]}),c.jsx("button",{className:"new-room-btn-small",onClick:()=>S(e=>!e),title:"Create New Room","aria-label":"Create New Room",children:"+"})]}),c.jsxs("div",{className:"sidebar-tabs",children:[c.jsxs("button",{className:"tab-btn "+("chats"===j?"active":""),onClick:()=>C("chats"),children:["Chats",Kr>0&&c.jsx("span",{className:"tab-unread-badge",children:Kr>99?"99+":Kr})]}),c.jsx("button",{className:"tab-btn "+("people"===j?"active":""),onClick:()=>C("people"),children:"People"}),c.jsx("button",{className:"tab-btn "+("requests"===j?"active":""),onClick:()=>C("requests"),children:"Requests"})]}),"requests"!==j&&c.jsxs("div",{className:"sidebar-search-wrap",children:[c.jsx("input",{className:"sidebar-search-input",type:"text",value:E,onChange:e=>R(e.target.value),placeholder:Zr,"aria-label":Zr}),E&&c.jsx("button",{type:"button",className:"sidebar-search-clear",onClick:()=>R(""),"aria-label":"Clear search",children:"X"})]}),c.jsx("div",{className:"sidebar-content",children:V?c.jsx("div",{className:"empty-state",children:"Loading..."}):"requests"===j?c.jsx(tt,{currentUserId:he,onRequestStatusChange:wt}):"people"===j?0===Hr.length?c.jsx("div",{className:"empty-state",children:"No users found."}):Hr.map(e=>(()=>{const t=_r(e);return c.jsxs("div",{className:"list-item",style:{cursor:"default"},children:[c.jsx("div",{className:"item-avatar",style:t?{backgroundImage:`url("${t}")`}:void 0,children:t?null:e.displayName?.charAt(0).toUpperCase()}),c.jsxs("div",{className:"item-info",children:[c.jsx("div",{className:"item-name",children:e.displayName}),"following"===M[e._id]?c.jsx("span",{className:"item-status",style:{color:"var(--success-color)"},children:"Following"}):c.jsx("button",{className:"icon-btn",style:{fontSize:"0.8rem",padding:"2px 8px",border:"1px solid var(--sidebar-border)"},onClick:async t=>{t.stopPropagation();try{await n.post(`${ar}/api/users/${he}/follow-request/${e._id}`),wt()}catch{alert("Failed to follow")}},children:"pending"===M[e._id]?"Pending":"Follow"})]})]},e._id)})()):c.jsxs(c.Fragment,{children:[x&&c.jsxs("div",{className:"create-form",children:[c.jsx("input",{className:"text-input",placeholder:"Room Name",value:b,onChange:e=>w(e.target.value)}),L&&c.jsx("p",{className:"room-error",children:L}),c.jsx("button",{className:"primary-btn",onClick:Dt,children:"Create"})]}),c.jsx("div",{className:"list-header",children:"Rooms"}),0===Yr.length?c.jsx("div",{className:"empty-state",children:"No rooms found."}):Yr.map(e=>(()=>{const t=xr(String(e._id)),r=ee[t]||0;return c.jsxs("div",{className:"list-item "+(a?._id===e._id?"active":""),onClick:()=>{Xe(t),d(e),h(null),A(!1),$(""),q({type:"",userId:""})},children:[c.jsx("div",{className:"item-avatar",children:"#"}),c.jsxs("div",{className:"item-info",children:[c.jsx("div",{className:"item-name",children:e.roomName}),c.jsxs("div",{className:"item-status-row",children:[c.jsxs("div",{className:"item-status",children:[e.members?.length||0," members"]}),r>0&&c.jsx("span",{className:"unread-badge",children:r>99?"99+":r})]})]})]},e._id)})()),c.jsx("div",{className:"list-header",style:{marginTop:"1rem"},children:"Direct Messages"}),0===Hr.length?c.jsx("div",{className:"empty-state",children:"No users found."}):Hr.map(e=>(()=>{const t=Sr(String(e._id)),r=ee[t]||0,n=_r(e);return c.jsxs("div",{className:"list-item "+(u?._id===e._id?"active":""),onClick:()=>{Xe(t),h(e),d(null),A(!1),D(!1),$(""),q({type:"",userId:""})},children:[c.jsxs("div",{className:"item-info item-info--dm",children:[c.jsx("button",{className:"item-avatar item-avatar-btn",onClick:t=>{t.stopPropagation(),Wt(e)},"aria-label":`View ${e.displayName} profile`,style:n?{backgroundImage:`url("${n}")`}:void 0,children:n?null:e.displayName?.charAt(0).toUpperCase()}),c.jsxs("div",{className:"item-copy",children:[c.jsx("div",{className:"item-name",children:e.displayName}),c.jsxs("div",{className:"item-status item-status--dm",children:[c.jsx("span",{className:"item-status-dot "+(e.onlineStatus?"online":"offline")}),e.onlineStatus?"Online":"Offline"]})]})]}),r>0&&c.jsx("span",{className:"unread-badge",children:r>99?"99+":r})]},e._id)})())]})})]}),Fr?c.jsxs("div",{className:"chat-main has-chat",children:[c.jsxs("div",{className:"chat-header",onClick:()=>{u&&(Q(u),G(!0))},style:{cursor:u?"pointer":"default"},children:[c.jsxs("div",{className:"chat-user",children:[c.jsx("button",{className:"icon-btn mobile-back-btn",type:"button",onClick:e=>{e.stopPropagation(),d(null),h(null),m([]),A(!1),D(!1)},"aria-label":"Back to conversations",title:"Back to conversations",children:""}),c.jsxs("div",{className:"chat-user-avatar",children:[Wr?c.jsx("img",{src:Wr,alt:`${Ar||"User"} avatar`,className:"chat-user-avatar-image",onError:e=>{e.currentTarget.style.display="none"}}):null,a?"#":$r]}),c.jsxs("div",{className:"chat-user-meta",children:[c.jsx("h2",{children:Ar}),c.jsx("p",{children:zr})]})]}),c.jsxs("div",{className:"chat-actions",children:[(a||u)&&c.jsx("button",{className:"icon-btn danger",onClick:e=>{e.stopPropagation(),Ut()},title:a&&!rn?"Only room creator can clear this chat":"Delete all messages in this chat","aria-label":"Delete all messages in this chat",disabled:W||!rn,children:W?"...":"Clear"}),u&&c.jsxs(c.Fragment,{children:[c.jsx("button",{className:"icon-btn call-action-btn",onClick:e=>{e.stopPropagation(),pt("audio")},title:"Start voice call","aria-label":"Start voice call",disabled:tn,children:c.jsx(Dr,{})}),c.jsx("button",{className:"icon-btn call-action-btn",onClick:e=>{e.stopPropagation(),pt("video")},title:"Start video call","aria-label":"Start video call",disabled:tn,children:c.jsx(Lr,{})})]}),a&&c.jsx("button",{className:"icon-btn",onClick:e=>{e.stopPropagation(),$(""),D(!0),q({type:"",userId:""})},children:"Info"})]})]}),c.jsxs("div",{className:"messages-container whatsapp-scroll",children:[p.map(e=>c.jsx(Vt,{message:e,currentUserId:he,onReact:At,onOpenSenderProfile:Wt,onReply:Mt,onDelete:Ot},e._id)),c.jsx("div",{ref:we})]}),c.jsxs("div",{className:"chat-input-area",children:[y&&c.jsxs("div",{className:"reply-composer-banner",role:"status","aria-live":"polite",children:[c.jsxs("div",{className:"reply-composer-copy",children:[c.jsxs("span",{className:"reply-composer-label",children:["Replying to ",ln]}),c.jsx("span",{className:"reply-composer-text",children:dn})]}),c.jsx("button",{type:"button",className:"reply-composer-cancel",onClick:()=>v(null),"aria-label":"Cancel reply",children:"Cancel"})]}),c.jsxs("div",{className:"input-wrapper",children:[c.jsxs("div",{className:"emoji-trigger",ref:Se,children:[c.jsx("button",{ref:je,className:"icon-btn emoji-open-btn",type:"button",onClick:Ct,disabled:on||I,"aria-label":"Open emoji picker","aria-expanded":T,children:c.jsx(Or,{})}),c.jsx($t,{isOpen:T,theme:Ze,anchorRef:Se,onClose:jt,onEmojiSelect:_t})]}),c.jsx("button",{className:"icon-btn upload-file-btn",type:"button",onClick:Rt,disabled:on||I,"aria-label":"Upload file",title:"Upload file",children:c.jsx(Ur,{})}),c.jsx("input",{ref:Ce,type:"file",className:"chat-file-input",onChange:Tt,disabled:on||I,hidden:!0,tabIndex:-1,accept:".pdf,.doc,.docx,.txt,.rtf,.odt,.xls,.xlsx,.ppt,.pptx,image/*"}),c.jsx("textarea",{ref:xe,className:"chat-input",placeholder:an,value:f,rows:1,disabled:on,onChange:e=>g(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),Et())}}),c.jsx("button",{className:"send-btn",onClick:Et,disabled:!f.trim()||on||I,children:"Send"})]}),cn&&c.jsx("p",{className:"chat-input-note",children:cn})]})]}):c.jsx("div",{className:"chat-main",children:c.jsxs("div",{className:"no-chat",children:[c.jsx("div",{className:"no-chat-icon",children:c.jsx(Br,{})}),c.jsx("h2",{children:"Select a chat to start messaging"})]})}),!Jr&&c.jsx("div",{className:"call-overlay",role:"dialog","aria-modal":"false","aria-label":"Call panel",children:c.jsxs("div",{className:"call-panel "+("video"===re.callType?"video-mode":"audio-mode"),children:[c.jsx("div",{className:"call-panel-head",children:c.jsxs("div",{className:"call-panel-meta",children:[c.jsx("h3",{children:Gr}),c.jsx("p",{children:Qr})]})}),c.jsxs("div",{className:"call-media "+("video"===re.callType?"video-mode":"audio-mode"),children:["video"===re.callType?c.jsxs(c.Fragment,{children:[c.jsx("video",{ref:Re,className:"call-remote-video",autoPlay:!0,playsInline:!0}),c.jsx("video",{ref:Ee,className:"call-local-video",autoPlay:!0,muted:!0,playsInline:!0})]}):c.jsx("div",{className:"call-audio-avatar",style:Xr?{backgroundImage:`url("${Xr}")`}:void 0,children:Xr?null:Gr?.charAt(0)?.toUpperCase()||"?"}),c.jsx("audio",{ref:Te,autoPlay:!0})]}),c.jsx("div",{className:"call-controls",children:"incoming"===re.status?c.jsxs(c.Fragment,{children:[c.jsx("button",{className:"primary-btn call-control-btn",onClick:mt,children:"Accept"}),c.jsx("button",{className:"icon-btn danger call-control-btn",onClick:ft,children:"Decline"})]}):c.jsxs(c.Fragment,{children:[c.jsx("button",{className:"icon-btn call-control-btn "+(ce?"active":""),onClick:gt,children:ce?"Unmute":"Mute"}),"video"===re.callType&&c.jsx("button",{className:"icon-btn call-control-btn "+(de?"active":""),onClick:yt,disabled:!en,children:de?"Camera On":"Camera Off"}),c.jsx("button",{className:"icon-btn danger call-control-btn",onClick:()=>dt({notifyPeer:!0,reason:"ended"}),children:"End"})]})})]})}),re.error&&c.jsx("div",{className:"call-error-banner",role:"status",children:re.error}),a&&U&&c.jsx("div",{className:"modal-overlay",onClick:()=>{D(!1),$(""),q({type:"",userId:""})},children:c.jsxs("div",{className:"modal room-info-modal",onClick:e=>e.stopPropagation(),children:[c.jsxs("div",{className:"modal-header room-info-header",children:[c.jsx("h3",{children:"Room Info"}),c.jsx("button",{className:"icon-btn room-info-close-btn",onClick:()=>{D(!1),$(""),q({type:"",userId:""})},children:"X"})]}),c.jsxs("div",{className:"modal-body room-info-modal-body",children:[c.jsxs("div",{className:"room-info-hero",children:[c.jsx("div",{className:"room-info-avatar",children:a.roomName?.charAt(0)?.toUpperCase()||"#"}),c.jsxs("div",{className:"room-info-hero-copy",children:[c.jsx("p",{className:"room-info-kicker",children:"Room"}),c.jsx("h4",{children:a.roomName}),c.jsxs("p",{children:[Kt.length," members - Created by ",er]})]})]}),c.jsxs("div",{className:"room-info-stats",children:[c.jsxs("div",{className:"room-info-stat",children:[c.jsx("span",{children:"Total Members"}),c.jsx("strong",{children:Kt.length})]}),c.jsxs("div",{className:"room-info-stat",children:[c.jsx("span",{children:"Your Role"}),c.jsx("strong",{children:cr?"Creator":"Member"})]})]}),z&&c.jsx("p",{className:"room-error",children:z}),c.jsxs("div",{className:"room-members-section",children:[c.jsxs("div",{className:"room-members-head",children:[c.jsxs("h4",{children:["Current Members ",c.jsx("span",{className:"room-count-pill",children:Kt.length})]}),!cr&&c.jsx("span",{className:"room-member-note",children:"Only creator can manage members"})]}),c.jsx("div",{className:"room-members-list",children:Kt.map((e,t)=>{const r=wr(e),n=Cr(e),s=Boolean(r)&&Boolean(Ht)&&String(r)===String(Ht)||Nr(n)===Nr(er),i="remove"===F.type&&F.userId===r,o=cr&&!s&&Boolean(r);return c.jsxs("div",{className:"room-member-row",children:[c.jsxs("div",{className:"room-member-meta",children:[c.jsx("div",{className:"room-member-avatar",children:n.charAt(0).toUpperCase()}),c.jsxs("div",{className:"room-member-copy",children:[c.jsx("div",{className:"room-member-name",children:n}),c.jsx("div",{className:"room-member-status",children:s?"Creator":e.onlineStatus?"Online":"Offline"})]})]}),s?c.jsx("span",{className:"room-member-badge",children:"Creator"}):cr?c.jsx("button",{className:"icon-btn room-member-remove-btn",onClick:()=>{o&&Bt(r)},disabled:i||!o,title:r?"Remove member":"Unable to remove this member.",children:i?"Removing...":"Remove"}):null]},`room-member-${r||Nr(n)||t}`)})})]}),c.jsxs("div",{className:"room-members-section",children:[c.jsxs("div",{className:"room-members-head",children:[c.jsx("h4",{children:"Add Existing Members"}),!cr&&c.jsx("span",{className:"room-member-note",children:"Only creator can manage members"})]}),0===Er.length?c.jsx("p",{className:"empty-state room-empty-state",children:"All available users are already in this room."}):c.jsx("div",{className:"room-add-list",children:Er.map(e=>{const t=wr(e),r=Cr(e),n="add"===F.type&&F.userId===t,s=cr&&Boolean(t);return c.jsxs("div",{className:"room-member-row",children:[c.jsxs("div",{className:"room-member-meta",children:[c.jsx("div",{className:"room-member-avatar",children:r.charAt(0).toUpperCase()}),c.jsxs("div",{className:"room-member-copy",children:[c.jsx("div",{className:"room-member-name",children:r}),c.jsx("div",{className:"room-member-status",children:e.onlineStatus?"Online":"Offline"})]})]}),c.jsx("button",{className:"primary-btn room-member-add-btn",onClick:()=>{s&&Lt(t)},disabled:!s||n,children:n?"Adding...":"Add"})]},`add-user-${t||Nr(r)}`)})})]})]})]})}),Y&&c.jsx(It,{user:{_id:he,username:ve?.username||me||"",bio:ve?.bio||"",avatarUrl:qr,phoneNumber:ve?.phoneNumber||"",email:ve?.email||""},onClose:()=>Z(!1),onUpdate:qt}),J&&X&&c.jsx(Pt,{user:X,onClose:()=>{G(!1),Q(null)}})]})}const $r="chatapp-auth-view",Fr="landing",qr="login",Wr="signup";function Kr(){return function(){const e=k();return Boolean(e.userId&&e.token)}()}function Vr({count:e}){const t=l.useMemo(()=>function(e){return Array.from({length:e},()=>({left:100*Math.random()+"%",top:100*Math.random()+"%",width:4*Math.random()+2+"px",height:4*Math.random()+2+"px",animationDelay:10*Math.random()+"s",animationDuration:10*Math.random()+10+"s"}))}(e),[e]);return c.jsx("div",{className:"particles","aria-hidden":"true",children:t.map((e,t)=>c.jsx("div",{className:"particle",style:e},t))})}function Hr(){const[e,t]=l.useState(()=>function(){const e=sessionStorage.getItem($r);return e===Fr||e===qr||e===Wr?e:Fr}()),[r,n]=l.useState(()=>Kr()),[s,i]=l.useState(localStorage.getItem("theme")||"light");l.useEffect(()=>{document.documentElement.setAttribute("data-theme",s),localStorage.setItem("theme",s)},[s]),l.useEffect(()=>{r?sessionStorage.removeItem($r):sessionStorage.setItem($r,e)},[e,r]),l.useEffect(()=>{const e=()=>{n(Kr())};return e(),window.addEventListener("storage",e),()=>{window.removeEventListener("storage",e)}},[]);return r?c.jsxs(c.Fragment,{children:[c.jsx(Vr,{count:20}),c.jsx(zr,{theme:s,setTheme:i})]}):e===Fr?c.jsxs("div",{className:"landing-page",children:[c.jsx(Vr,{count:15}),c.jsx("h1",{children:"Welcome to ChatApp!"}),c.jsx("p",{className:"landing-subtitle",children:"Experience the future of conversation with our Liquid Glass interface."}),c.jsx("button",{className:"begin-btn",onClick:()=>{t(qr)},children:"Let's Begin"})]}):c.jsxs("div",{className:"container",children:[c.jsx(Vr,{count:10}),c.jsx("button",{className:"theme-toggle-btn",style:{position:"fixed",top:"max(1rem, env(safe-area-inset-top))",right:"max(1rem, env(safe-area-inset-right))",zIndex:20},onClick:()=>{i(e=>"light"===e?"dark":"light")},title:"dark"===s?"Switch to Light Mode":"Switch to Dark Mode","aria-label":"dark"===s?"Switch to Light Mode":"Switch to Dark Mode",children:c.jsx("span",{className:"theme-toggle-btn__icon","aria-hidden":"true",children:"dark"===s?c.jsxs("svg",{viewBox:"0 0 24 24",role:"presentation",children:[c.jsx("circle",{cx:"12",cy:"12",r:"4.2"}),c.jsx("path",{d:"M12 2.5v2.2M12 19.3v2.2M4.9 4.9l1.6 1.6M17.5 17.5l1.6 1.6M2.5 12h2.2M19.3 12h2.2M4.9 19.1l1.6-1.6M17.5 6.5l1.6-1.6"})]}):c.jsx("svg",{viewBox:"0 0 24 24",role:"presentation",children:c.jsx("path",{d:"M20.4 14.5a8.7 8.7 0 1 1-10.9-10.9 7.4 7.4 0 1 0 10.9 10.9z"})})})}),c.jsx("h1",{children:e===qr?"Welcome Back":"Create Account"}),e===qr?c.jsx(E,{onLoginSuccess:()=>n(Kr()),onSwitchToSignup:()=>t(Wr)}):c.jsx(R,{onSignupSuccess:()=>{t(qr),alert("Account created! Please login with your credentials.")},onSwitchToLogin:()=>t(qr)})]})}!function(e={}){const{immediate:t=!1,onNeedRefresh:r,onOfflineReady:n,onRegistered:s,onRegisteredSW:i,onRegisterError:o}=e;let a,c;c=async function(){if("serviceWorker"in navigator){if(a=await f(async()=>{const{Workbox:e}=await import("./workbox-window.prod.es5-CLYUWRvB.js");return{Workbox:e}},[],import.meta.url).then(({Workbox:e})=>new e("./sw.js",{scope:"./",type:"classic"})).catch(e=>{o?.(e)}),!a)return;a.addEventListener("activated",e=>{(e.isUpdate||e.isExternal)&&window.location.reload()}),a.addEventListener("installed",e=>{e.isUpdate||n?.()}),a.register({immediate:t}).then(e=>{i?i("./sw.js",e):s?.(e)}).catch(e=>{o?.(e)})}}()}({immediate:!0}),p.createRoot(document.getElementById("root")).render(c.jsx(d.StrictMode,{children:c.jsx(Hr,{})}));export{d as $,l as r};
